# ä¸€ã€ç®€ä»‹

https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b336601f265da598e13f917

Redi æ˜¯äº’è”ç½‘æŠ€æœ¯é¢†åŸŸä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„å­˜å‚¨ä¸­é—´ä»¶ï¼Œä»–æ˜¯[Remote Dictionary Service]çš„é¦–å­—æ¯ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯[è¿œç¨‹å­—å…¸æœåŠ¡].

1ã€å¯ä»¥ä½¿ç”¨åœºæ™¯

	1ï¼‰ã€è®°å½•å¸–å­çš„ç‚¹èµæ•°ã€è¯„è®ºæ•°å’Œç‚¹å‡»æ•°ï¼ˆhashï¼‰.
	
	2ï¼‰ã€è®°å½•ç”¨æˆ·çš„å¸–å­IDåˆ—è¡¨ï¼ˆæ’åºï¼‰ï¼Œä¾¿äºå¿«é€Ÿæ˜¾ç¤ºç”¨æˆ·çš„å¸–å­åˆ—è¡¨ï¼ˆzsetï¼‰
	
	3ï¼‰ã€è®°å½•å¸–å­çš„æ ‡é¢˜ã€æ‘˜è¦ã€ä½œè€…å’Œå°é¢ä¿¡æ¯ï¼Œç”¨äºåˆ—è¡¨é¡µå±•ç¤ºï¼ˆhashï¼‰
	
	4ï¼‰ã€è®°å½•å¸–å­çš„ç‚¹èµç”¨æˆ· ID åˆ—è¡¨ã€è¯„è®º ID åˆ—è¡¨ï¼Œç”¨æˆ·æ˜¾ç¤ºå’Œå»é‡è®¡æ•°ï¼ˆzsetï¼‰ã€‚
	
	5ï¼‰ã€ç¼“å­˜è¿‘æœŸçƒ­å¸–å†…å®¹ï¼ˆå¸–å­å†…å®¹æ§ä»¶å ç”¨æ¯”è¾ƒå¤§ï¼‰ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ï¼ˆhashï¼‰ã€‚
	
	6ï¼‰ã€è®°å½•å¸–å­çš„ç›¸å…³æ–‡ç«  IDï¼Œæ ¹æ®å†…å®¹æ¨èç›¸å…³å¸–å­ï¼ˆlistï¼‰.
	
	7ï¼‰ã€å¦‚æœå¸–å­ ID æ˜¯æ•´æ•°è‡ªå¢ï¼Œå¯ä»¥ä½¿ç”¨ Redis æ¥åˆ†é…å¸–å­ ID ï¼ˆè®¡æ•°å™¨ï¼‰ã€‚
	
	8ï¼‰ã€æ”¶è—é›†å’Œå¸–å­ä¹‹é—´çš„å…³ç³»ï¼ˆzsetï¼‰
	
	9ï¼‰ã€è®°å½•çƒ­æ¦œå¸–å­ ID åˆ—è¡¨ã€æ€»çƒ­æ¦œå’Œåˆ†ç±»çƒ­æ¦œï¼ˆzsetï¼‰
	
	10ï¼‰ã€ç¼“å­˜ç”¨æˆ·è¡Œä¸ºå†å²ï¼Œè¿›è¡Œæ¶æ„è¡Œä¸ºè¿‡æ»¤ï¼ˆzsetï¼Œhashï¼‰

# äºŒã€åŸºç¡€ RedisåŸºç¡€æ•°æ®ç»“æ„

### Rediså®‰è£…

Docker æ–¹å¼

```assembly
# æ‹‰å– redis é•œåƒ
> docker pull redis
# è¿è¡Œ redis å®¹å™¨
> docker run --name myredis -d -p6379:6379 redis
# æ‰§è¡Œå®¹å™¨ä¸­çš„ redis-cliï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œæ“ä½œ redis
> docker exec -it myredis redis-cli...
```

Github æºç ç¼–å‘æ–¹å¼

```assembly
# ä¸‹è½½æºç 
> git clone --branch 2.8 --depth 1 git@github.com:antirez/redis.git
> cd redis
# ç¼–è¯‘
> make
> cd src
# è¿è¡ŒæœåŠ¡å™¨ï¼Œdaemonizeè¡¨ç¤ºåœ¨åå°è¿è¡Œ
> ./redis-server --daemonize yes
# è¿è¡Œå‘½ä»¤è¡Œ
> ./redis-cli...
```

### Redis åŸºç¡€æ•°æ®ç»“æ„

Redis æœ‰5ç§åŸºç¡€æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«ä¸ºï¼šstring(å­—ç¬¦ä¸²)ã€list(åˆ—è¡¨)ã€set(é›†åˆ)ã€hash(å“ˆå¸Œ)å’Œzset(æœ‰åºé›†åˆ)ã€‚

##### string(å­—ç¬¦ä¸²)

å­—ç¬¦ä¸²stringæ˜¯Redisæœ€ç®€å•çš„æ•°æ®ç»“æ„ã€‚Redisæ‰€æœ‰çš„æ•°æ®ç»“æ„éƒ½æ˜¯ä»¥ å”¯ä¸€çš„keyå­—ç¬¦ä¸²ä½œä¸ºåç§°ï¼Œç„¶åé€šè¿‡è¿™ä¸ªå”¯ä¸€çš„keyå€¼æ¥è·å–ç›¸åº”çš„valueæ•°æ®ã€‚ä¸åŒç±»å‹çš„æ•°æ®ç»“æ„çš„å·®å¼‚å°±åœ¨äºvalueçš„ç»“æ„ä¸ä¸€æ ·ã€‚

![](16458d666d851a12.gif)

å­—ç¬¦ä¸²ç»“æ„ä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œä¸€ä¸ªå¸¸è§çš„ç”¨é€”å°±æ˜¯ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ã€‚æˆ‘ä»¬å°†ç”¨æˆ·ä¿¡æ¯ç»“æ„ä½“ä½¿ç”¨JSONåºåˆ—åŒ–åŸå­—ç¬¦ä¸²ï¼Œç„¶åå°†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²å¡è¿›Redisæ¥ç¼“å­˜ã€‚åŒæ ·ï¼Œå–ç”¨æˆ·ä¿¡æ¯ä¼šç»è¿‡ä¸€æ¬¡ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚

![](1535294401582.jpg)

Redisçš„å­—ç¬¦ä¸²æ˜¯åŠ¨æ€å­—ç¬¦ä¸²ï¼Œæ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå†…éƒ¨ç»“æ„å®ç°ä¸Šç±»ä¼¼äºjavaçš„ArrayListï¼Œé‡‡ç”¨æ¬²åˆ†é…è£èª‰æ§ä»¶çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ï¼Œå¦‚å›¾ä¸­æ‰€ç¤ºï¼Œå†…éƒ¨ä¸ºå½“å‰å­—ç¬¦ä¸²å®é™…åˆ†é…çš„æ§ä»¶capacityä¸€èˆ¬è¦é«˜äºå®é™…å­—ç¬¦ä¸²é•¿åº¦lenã€‚å½“å­—ç¬¦ä¸²é•¿åº¦å°äº1Mæ—¶ï¼Œæ‰©å®¹éƒ½æ˜¯åŠ å€ç°æœ‰çš„æ§ä»¶ï¼Œå¦‚æœè¶…è¿‡1ï¼Œæ‰©å®¹æ—¶ä¸€æ¬¡åªä¼šå¤šæ‰©1Mçš„æ§ä»¶ã€‚

##### é”®å€¼å¯¹

```assembly
> set name codehole
OK
> get name
"codehole"
> exists name
(integer) 1
> del name
(integer) 1
> get name
(nil)
```

##### æ‰¹é‡é”®å€¼å¯¹

å¯ä»¥æ‰¹é‡å¯¹å¤šä¸ªå­—ç¬¦ä¸²è¿›è¡Œè¯»å†™ï¼ŒèŠ‚çœç½‘ç»œè€—æ—¶å¼€é”€

```assembly
> set name1 codehole
OK
> set name2 holycoder
OK
> mget name1 name2 name3 # è¿”å›ä¸€ä¸ªåˆ—è¡¨
1) "codehole"
2) "holycoder"
3) (nil)
> mset name1 boy name2 girl name3 unknown
> mget name1 name2 name3
1) "boy"
2) "girl"
3) "unknown"...
```

##### è¿‡æœŸå’Œsetå‘½ä»¤æ‰©å±•

å¯ä»¥å¯¹keyiè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œåˆ°ç‚¹è‡ªåŠ¨åˆ é™¤ï¼Œè¿™ä¸ªåŠŸèƒ½å¸¸ç”¨æ¥æ§åˆ¶ç¼“å­˜çš„å¤±æ•ˆæ—¶é—´ã€‚ä¸è¿‡è¿™ä¸ª[]è‡ªåŠ¨åˆ é™¤]çš„æœºåˆ¶æ¯”è¾ƒå¤æ‚ã€‚

```assembly
> set name codehole
> get name
"codehole"
> expire name 5  # 5s åè¿‡æœŸ
...  # wait for 5s
> get name
(nil)

> setex name 5 codehole  # 5s åè¿‡æœŸï¼Œç­‰ä»·äº set+expire
> get name
"codehole"
... # wait for 5s
> get name
(nil)

> setnx name codehole  # å¦‚æœ name ä¸å­˜åœ¨å°±æ‰§è¡Œ set åˆ›å»º
(integer) 1
> get name
"codehole"
> setnx name holycoder
(integer) 0  # å› ä¸º name å·²ç»å­˜åœ¨ï¼Œæ‰€ä»¥ set åˆ›å»ºä¸æˆåŠŸ
> get name
"codehole"  # æ²¡æœ‰æ”¹å˜...
```

##### è®¡æ•°

å¦‚æœvalueå€¼æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œè¿˜å¯ä»¥å¯¹å®ƒè¿›è¡Œè‡ªå¢æ“ä½œã€‚è‡ªå¢æ˜¯æœ‰èŒƒå›´çš„ï¼Œè®©çš„èŒƒå›´æ˜¯signed longçš„æœ€å¤§å€¼æœ€å°å€¼ï¼Œè¶…è¿‡äº†è¿™ä¸ªå€¼ï¼ŒRedisæŠ¥é”™ã€‚

```assembly
> set age 30
OK
> incr age
(integer) 31
> incrby age 5
(integer) 36
> incrby age -5
(integer) 31
> set codehole 9223372036854775807  # Long.Max
OK
> incr codehole
(error) ERR increment or decrement would overflow
```

å­—ç¬¦ä¸²æ˜¯ç”±å¤šä¸ªå­—èŠ‚ç»„æˆï¼Œæ¯ä¸ªå­—èŠ‚åˆæ˜¯ç”±8ä¸ªbitç»„æˆï¼Œå¦‚æ­¤ä¾¿å¯ä»¥å°†ä¸€ä¸ªå­—ç¬¦ä¸²çœ‹æˆå¾ˆå¤šbitçš„ç»„åˆï¼Œè¿™ä¾¿æ˜¯bitmap [ä½å›¾] æ•°æ®ç»“æ„ï¼Œä½å›¾çš„å…·ä½“ä½¿ç”¨ä¼šæ”¾åˆ°åé¢çš„ç« èŠ‚æ¥è®²ã€‚

##### list (åˆ—è¡¨)

Redisçš„åˆ—è¡¨ç›¸å½“äº java è¯­è¨€é‡Œé¢çš„ LinkedListï¼Œæ³¨æ„å®ƒæ˜¯é“¾è¡¨è€Œä¸æ˜¯æ•°ç»„ï¼Œè¿™æ„å‘³ç€listçš„æ’å…¥å’Œåˆ é™¤æ“ä½œéå¸¸äºï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œä½†æ˜¯ç´¢å¼•å®šä½å¾ˆæ…¢ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œè¿™ç‚¹æ”˜å¤·éå¸¸æ„å¤–ã€‚

å½“åˆ—è¡¨å¼¹å‡ºäº†æœ€åä¸€ä¸ªå…ƒç´ ä¹‹åï¼Œè¯¥æ•°æ®ç»“æ„è‡ªåŠ¨è¢«åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶

![](1645918c2cdf772e.gif)

Redisçš„åˆ—è¡¨ç»“æ„å¸¸ç”¨æ¥åšå¼‚æ­¥é˜Ÿåˆ—ä½¿ç”¨ã€‚å°†éœ€è¦å»¶åå¤„ç†çš„ä»»åŠ¡ç»“æ„ä½“åºåˆ—åŒ–æˆå­—ç¬¦ä¸²å¡è¿›Redisåˆ—è¡¨ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä»è¿™ä¸ªåˆ—è¡¨ä¸­è½®è®­æ•°æ®è¿›è¡Œå¤„ç†ã€‚

##### å³è¾¹è¿›å·¦è¾¹å‡ºï¼šé˜Ÿåˆ—

```assembly
> rpush books python java golang
(integer) 3
> llen books
(integer) 3
> lpop books
"python"
> lpop books
"java"
> lpop books
"golang"
> lpop books
(nil)
```

å³è¾¹é‡‘å³è¾¹å‡ºï¼šæ ˆ

```assembly
> rpush books python java golang
(integer) 3
> rpop books
"golang"
> rpop books
"java"
> rpop books
"python"
> rpop books
(nil)
```

##### æ»¡æ“ä½œ

lindexç›¸å½“äºjavaé“¾è¡¨çš„get(int index)æ–¹æ³•ï¼Œå®ƒéœ€è¦å¯¹é“¾è¡¨è¿›è¡Œéå†ï¼Œæ€§èƒ½éšç€å‚æ•°indexå¢å¤§è€Œå˜å·®

ltrimä¸€ä¸ªå·²å­˜åœ¨çš„ listï¼Œè¿™æ · list å°±ä¼šåªåŒ…å«æŒ‡å®šèŒƒå›´çš„æŒ‡å®šå…ƒç´ ã€‚start å’Œ stop éƒ½æ˜¯ç”±0å¼€å§‹è®¡æ•°çš„ï¼Œ è¿™é‡Œçš„ 0 æ˜¯åˆ—è¡¨é‡Œçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆè¡¨å¤´ï¼‰ï¼Œ1 æ˜¯ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä»¥æ­¤ç±»æ¨ã€‚

```assembly
> rpush books python java golang
(integer) 3
> lindex books 1  # O(n) æ…ç”¨
"java"
> lrange books 0 -1  # è·å–æ‰€æœ‰å…ƒç´ ï¼ŒO(n) æ…ç”¨
1) "python"
2) "java"
3) "golang"
> ltrim books 1 -1 # O(n) æ…ç”¨
OK
> lrange books 0 -1
1) "java"
2) "golang"
> ltrim books 1 0 # è¿™å…¶å®æ˜¯æ¸…ç©ºäº†æ•´ä¸ªåˆ—è¡¨ï¼Œå› ä¸ºåŒºé—´èŒƒå›´é•¿åº¦ä¸ºè´Ÿ
OK
> llen books
(integer) 0
```

##### å¿«é€Ÿåˆ—è¡¨

![](164d975cac9559c5.png)

å¦‚æœåœ¨æ·±å…¥ä¸€ç‚¹ï¼Œä½ ä¼šå‘ç°Redisåº•å±‚å­˜å‚¨çš„è¿˜ä¸æ˜¯ä¸€ä¸ªç®€å•çš„LinkedListï¼Œè€Œæ˜¯ç§°ä¹‹ä¸ºå¿«é€Ÿé“¾è¡¨quicklistçš„ä¸€ä¸ªç»“æ„ã€‚

é¦–å…ˆåœ¨åˆ—è¡¨å…ƒç´ è¾ƒå°‘çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œè¿™ä¸ªç»“æ„æ˜¯ziplistï¼Œä¹Ÿå³ä½¿å‹ç¼©åˆ—è¡¨ã€‚ä»–å°†æ‰€æœ‰çš„å…ƒç´ ç´§æŒ¨ç€ä¸€èµ·å­˜å‚¨ï¼Œåˆ†é…çš„æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ã€‚å½“æ•°æ®é‡æ¯”è¾ƒå¤šçš„æ—¶å€™æ‰ä¼šæ”¹æˆquicklistã€‚å› ä¸ºæ™®é€šçš„é“¾è¡¨éœ€è¦çš„é™„åŠ æŒ‡é’ˆç©ºé—´å¤ªå¤§ï¼Œä¼šæ¯”è¾ƒæµªè´¹ç©ºé—´ï¼Œè€Œä¸”ä¼šåŠ é‡å†…å­˜çš„ç¢ç‰‡åŒ–ã€‚æ¯”å¦‚è¿™ä¸ªåˆ—è¡¨é‡Œå­˜çš„åªæ˜¯intç±»å‹çš„æ•°æ®ï¼Œç»“æ„ä¸Šè¿˜éœ€è¦ä¸¤ä¸ªé¢å¤–çš„æŒ‡é’ˆprevå’Œnextã€‚æ‰€ä»¥Rediså°†é“¾è¡¨å’Œziplistç»“åˆèµ·æ¥ç»„æˆäº†quicklistã€‚ä¹Ÿå°±æ˜¯å°†å¤šä¸ªziplistä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²èµ·æ¥ä½¿ç”¨ã€‚è¿™æ ·æ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œåˆä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™ã€‚

##### hash(å­—å…¸)

Redis çš„å­—å…¸ç›¸å½“äº Java è¯­è¨€é‡Œé¢çš„ HashMapï¼Œå®ƒæ˜¯æ— åºå­—å…¸ã€‚å†…éƒ¨å®ç°ç»“æ„ä¸ŠåŒ Java çš„ HashMap ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„æ•°ç»„ + é“¾è¡¨äºŒç»´ç»“æ„ã€‚ç¬¬ä¸€ç»´ hash çš„æ•°ç»„ä½ç½®ç¢°æ’æ—¶ï¼Œå°±ä¼šå°†ç¢°æ’çš„å…ƒç´ ä½¿ç”¨é“¾è¡¨ä¸²æ¥èµ·æ¥ã€‚

 ![](1535296960432.jpg)

ä¸åŒçš„æ˜¯ï¼ŒRedis çš„å­—å…¸çš„å€¼åªèƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œå¦å¤–å®ƒä»¬ rehash çš„æ–¹å¼ä¸ä¸€æ ·ï¼Œå› ä¸º Java çš„ HashMap åœ¨å­—å…¸å¾ˆå¤§æ—¶ï¼Œrehash æ˜¯ä¸ªè€—æ—¶çš„æ“ä½œï¼Œéœ€è¦ä¸€æ¬¡æ€§å…¨éƒ¨ rehashã€‚Redis ä¸ºäº†é«˜æ€§èƒ½ï¼Œä¸èƒ½å µå¡æœåŠ¡ï¼Œæ‰€ä»¥é‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥

![](1535297073325.jpg)

æ¸è¿›å¼ rehash ä¼šåœ¨ rehash çš„åŒæ—¶ï¼Œä¿ç•™æ–°æ—§ä¸¤ä¸ª hash ç»“æ„ï¼ŒæŸ¥è¯¢æ—¶ä¼šåŒæ—¶æŸ¥è¯¢ä¸¤ä¸ª hash ç»“æ„ï¼Œç„¶ååœ¨åç»­çš„å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠ hash æ“ä½œæŒ‡ä»¤ä¸­ï¼Œå¾ªåºæ¸è¿›åœ°å°†æ—§ hash çš„å†…å®¹ä¸€ç‚¹ç‚¹è¿ç§»åˆ°æ–°çš„ hash ç»“æ„ä¸­ã€‚å½“æ¬è¿å®Œæˆäº†ï¼Œå°±ä¼šä½¿ç”¨æ–°çš„hashç»“æ„å–è€Œä»£ä¹‹ã€‚ 

å½“ hash ç§»é™¤äº†æœ€åä¸€ä¸ªå…ƒç´ ä¹‹åï¼Œè¯¥æ•°æ®ç»“æ„è‡ªåŠ¨è¢«åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚

![](16458ef82907e5e1)

hash ç»“æ„ä¹Ÿå¯ä»¥ç”¨æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œä¸åŒäºå­—ç¬¦ä¸²ä¸€æ¬¡æ€§éœ€è¦å…¨éƒ¨åºåˆ—åŒ–æ•´ä¸ªå¯¹è±¡ï¼Œhash å¯ä»¥å¯¹ç”¨æˆ·ç»“æ„ä¸­çš„æ¯ä¸ªå­—æ®µå•ç‹¬å­˜å‚¨ã€‚è¿™æ ·å½“æˆ‘ä»¬éœ€è¦è·å–ç”¨æˆ·ä¿¡æ¯æ—¶å¯ä»¥è¿›è¡Œéƒ¨åˆ†è·å–ã€‚è€Œä»¥æ•´ä¸ªå­—ç¬¦ä¸²çš„å½¢å¼å»ä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„è¯å°±åªèƒ½ä¸€æ¬¡æ€§å…¨éƒ¨è¯»å–ï¼Œè¿™æ ·å°±ä¼šæ¯”è¾ƒæµªè´¹ç½‘ç»œæµé‡ã€‚ hash ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œ

hash ç»“æ„çš„å­˜å‚¨æ¶ˆè€—è¦é«˜äºå•ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ°åº•è¯¥ä½¿ç”¨ hash è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µå†ä¸‰æƒè¡¡ã€‚

```assembly
> hset books java "think in java"  # å‘½ä»¤è¡Œçš„å­—ç¬¦ä¸²å¦‚æœåŒ…å«ç©ºæ ¼ï¼Œè¦ç”¨å¼•å·æ‹¬èµ·æ¥
(integer) 1
> hset books golang "concurrency in go"
(integer) 1
> hset books python "python cookbook"
(integer) 1
> hgetall books  # entries()ï¼Œkey å’Œ value é—´éš”å‡ºç°
1) "java"
2) "think in java"
3) "golang"
4) "concurrency in go"
5) "python"
6) "python cookbook"
> hlen books
(integer) 3
> hget books java
"think in java"
> hset books golang "learning go programming"  # å› ä¸ºæ˜¯æ›´æ–°æ“ä½œï¼Œæ‰€ä»¥è¿”å› 0
(integer) 0
> hget books golang
"learning go programming"
> hmset books java "effective java" python "learning python" golang "modern golang programming"  # æ‰¹é‡ set
OK
```

åŒå­—ç¬¦ä¸²ä¸€æ ·ï¼Œhash ç»“æ„ä¸­çš„å•ä¸ªå­ key ä¹Ÿå¯ä»¥è¿›è¡Œè®¡æ•°ï¼Œå®ƒå¯¹åº”çš„æŒ‡ä»¤æ˜¯Â `hincrby`ï¼Œå’ŒÂ `incr`Â ä½¿ç”¨åŸºæœ¬ä¸€æ ·ã€‚

```assembly
# è€é’±åˆè€äº†ä¸€å²
> hincrby user-laoqian age 1
(integer) 30
```

##### set(é›†åˆ)

Redis çš„é›†åˆç›¸å½“äº Java è¯­è¨€é‡Œé¢çš„ HashSetï¼Œå®ƒå†…éƒ¨çš„é”®å€¼å¯¹æ˜¯æ— åºçš„å”¯ä¸€çš„ã€‚å®ƒçš„å†…éƒ¨å®ç°ç›¸å½“äºä¸€ä¸ªç‰¹æ®Šçš„å­—å…¸ï¼Œå­—å…¸ä¸­æ‰€æœ‰çš„ value éƒ½æ˜¯ä¸€ä¸ªå€¼`NULL`ã€‚

å½“é›†åˆä¸­æœ€åä¸€ä¸ªå…ƒç´ ç§»é™¤ä¹‹åï¼Œæ•°æ®ç»“æ„è‡ªåŠ¨åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚

![](16458e2da04f1a2d)

set ç»“æ„å¯ä»¥ç”¨æ¥å­˜å‚¨æ´»åŠ¨ä¸­å¥–çš„ç”¨æˆ· IDï¼Œå› ä¸ºæœ‰å»é‡åŠŸèƒ½ï¼Œå¯ä»¥ä¿è¯åŒä¸€ä¸ªç”¨æˆ·ä¸ä¼šä¸­å¥–ä¸¤æ¬¡ã€‚

```assembly
> sadd books python
(integer) 1
> sadd books python  #  é‡å¤
(integer) 0
> sadd books java golang
(integer) 2
> smembers books  # æ³¨æ„é¡ºåºï¼Œå’Œæ’å…¥çš„å¹¶ä¸ä¸€è‡´ï¼Œå› ä¸º set æ˜¯æ— åºçš„
1) "java"
2) "python"
3) "golang"
> sismember books java  # æŸ¥è¯¢æŸä¸ª value æ˜¯å¦å­˜åœ¨ï¼Œç›¸å½“äº contains(o)
(integer) 1
> sismember books rust
(integer) 0
> scard books  # è·å–é•¿åº¦ç›¸å½“äº count()
(integer) 3
> spop books  # å¼¹å‡ºä¸€ä¸ª
"java"
```

##### zset(æœ‰åºåˆ—è¡¨)

zset å¯èƒ½æ˜¯ Redis æä¾›çš„æœ€ä¸ºç‰¹è‰²çš„æ•°æ®ç»“æ„ï¼Œå®ƒä¹Ÿæ˜¯åœ¨é¢è¯•ä¸­é¢è¯•å®˜æœ€çˆ±é—®çš„æ•°æ®ç»“æ„ã€‚å®ƒç±»ä¼¼äº Java çš„ SortedSet å’Œ HashMap çš„ç»“åˆä½“ï¼Œä¸€æ–¹é¢å®ƒæ˜¯ä¸€ä¸ª setï¼Œä¿è¯äº†å†…éƒ¨ value çš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢å®ƒå¯ä»¥ç»™æ¯ä¸ª value èµ‹äºˆä¸€ä¸ª scoreï¼Œä»£è¡¨è¿™ä¸ª value çš„æ’åºæƒé‡ã€‚å®ƒçš„å†…éƒ¨å®ç°ç”¨çš„æ˜¯ä¸€ç§å«åšã€Œè·³è·ƒåˆ—è¡¨ã€çš„æ•°æ®ç»“æ„ã€‚

zset ä¸­æœ€åä¸€ä¸ª value è¢«ç§»é™¤åï¼Œæ•°æ®ç»“æ„è‡ªåŠ¨åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚

 ![](16458f9f679a8bb0)

zset å¯ä»¥ç”¨æ¥å­˜ç²‰ä¸åˆ—è¡¨ï¼Œvalue å€¼æ˜¯ç²‰ä¸çš„ç”¨æˆ· IDï¼Œscore æ˜¯å…³æ³¨æ—¶é—´ã€‚æˆ‘ä»¬å¯ä»¥å¯¹ç²‰ä¸åˆ—è¡¨æŒ‰å…³æ³¨æ—¶é—´è¿›è¡Œæ’åºã€‚

zset è¿˜å¯ä»¥ç”¨æ¥å­˜å‚¨å­¦ç”Ÿçš„æˆç»©ï¼Œvalue å€¼æ˜¯å­¦ç”Ÿçš„ IDï¼Œscore æ˜¯ä»–çš„è€ƒè¯•æˆç»©ã€‚æˆ‘ä»¬å¯ä»¥å¯¹æˆç»©æŒ‰åˆ†æ•°è¿›è¡Œæ’åºå°±å¯ä»¥å¾—åˆ°ä»–çš„åæ¬¡ã€‚

```assembly
> zadd books 9.0 "think in java"
(integer) 1
> zadd books 8.9 "java concurrency"
(integer) 1
> zadd books 8.6 "java cookbook"
(integer) 1
> zrange books 0 -1  # æŒ‰ score æ’åºåˆ—å‡ºï¼Œå‚æ•°åŒºé—´ä¸ºæ’åèŒƒå›´
1) "java cookbook"
2) "java concurrency"
3) "think in java"
> zrevrange books 0 -1  # æŒ‰ score é€†åºåˆ—å‡ºï¼Œå‚æ•°åŒºé—´ä¸ºæ’åèŒƒå›´
1) "think in java"
2) "java concurrency"
3) "java cookbook"
> zcard books  # ç›¸å½“äº count()
(integer) 3
> zscore books "java concurrency"  # è·å–æŒ‡å®š value çš„ score
"8.9000000000000004"  # å†…éƒ¨ score ä½¿ç”¨ double ç±»å‹è¿›è¡Œå­˜å‚¨ï¼Œæ‰€ä»¥å­˜åœ¨å°æ•°ç‚¹ç²¾åº¦é—®é¢˜
> zrank books "java concurrency"  # æ’å
(integer) 1
> zrangebyscore books 0 8.91  # æ ¹æ®åˆ†å€¼åŒºé—´éå† zset
1) "java cookbook"
2) "java concurrency"
> zrangebyscore books -inf 8.91 withscores # æ ¹æ®åˆ†å€¼åŒºé—´ (-âˆ, 8.91] éå† zsetï¼ŒåŒæ—¶è¿”å›åˆ†å€¼ã€‚inf ä»£è¡¨ infiniteï¼Œæ— ç©·å¤§çš„æ„æ€ã€‚
1) "java cookbook"
2) "8.5999999999999996"
3) "java concurrency"
4) "8.9000000000000004"
> zrem books "java concurrency"  # åˆ é™¤ value
(integer) 1
> zrange books 0 -1
1) "java cookbook"
2) "think in java"
```

**è·³è·ƒåˆ—è¡¨**

zset å†…éƒ¨çš„æ’åºåŠŸèƒ½æ˜¯é€šè¿‡ã€Œè·³è·ƒåˆ—è¡¨ã€æ•°æ®ç»“æ„æ¥å®ç°çš„ï¼Œå®ƒçš„ç»“æ„éå¸¸ç‰¹æ®Šï¼Œä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚

å› ä¸º zset è¦æ”¯æŒéšæœºçš„æ’å…¥å’Œåˆ é™¤ï¼Œæ‰€ä»¥å®ƒä¸å¥½ä½¿ç”¨æ•°ç»„æ¥è¡¨ç¤ºã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªæ™®é€šçš„é“¾è¡¨ç»“æ„ã€‚

![](CB70E11E-3118-4651-948C-722C1FC98268.png)

æˆ‘ä»¬éœ€è¦è¿™ä¸ªé“¾è¡¨æŒ‰ç…§ score å€¼è¿›è¡Œæ’åºã€‚è¿™æ„å‘³ç€å½“æœ‰æ–°å…ƒç´ éœ€è¦æ’å…¥æ—¶ï¼Œè¦å®šä½åˆ°ç‰¹å®šä½ç½®çš„æ’å…¥ç‚¹ï¼Œè¿™æ ·æ‰å¯ä»¥ç»§ç»­ä¿è¯é“¾è¡¨æ˜¯æœ‰åºçš„ã€‚é€šå¸¸æˆ‘ä»¬ä¼šé€šè¿‡äºŒåˆ†æŸ¥æ‰¾æ¥æ‰¾åˆ°æ’å…¥ç‚¹ï¼Œä½†æ˜¯äºŒåˆ†æŸ¥æ‰¾çš„å¯¹è±¡å¿…é¡»æ˜¯æ•°ç»„ï¼Œåªæœ‰æ•°ç»„æ‰å¯ä»¥æ”¯æŒå¿«é€Ÿä½ç½®å®šä½ï¼Œé“¾è¡¨åšä¸åˆ°ï¼Œé‚£è¯¥æ€ä¹ˆåŠï¼Ÿ 

æƒ³æƒ³ä¸€ä¸ªåˆ›ä¸šå…¬å¸ï¼Œåˆšå¼€å§‹åªæœ‰å‡ ä¸ªäººï¼Œå›¢é˜Ÿæˆå‘˜ä¹‹é—´äººäººå¹³ç­‰ï¼Œéƒ½æ˜¯è”åˆåˆ›å§‹äººã€‚éšç€å…¬å¸çš„æˆé•¿ï¼Œäººæ•°æ¸æ¸å˜å¤šï¼Œå›¢é˜Ÿæ²Ÿé€šæˆæœ¬éšä¹‹å¢åŠ ã€‚è¿™æ—¶å€™å°±ä¼šå¼•å…¥ç»„é•¿åˆ¶ï¼Œå¯¹å›¢é˜Ÿè¿›è¡Œåˆ’åˆ†ã€‚æ¯ä¸ªå›¢é˜Ÿä¼šæœ‰ä¸€ä¸ªç»„é•¿ã€‚å¼€ä¼šçš„æ—¶å€™åˆ†å›¢é˜Ÿè¿›è¡Œï¼Œå¤šä¸ªç»„é•¿ä¹‹é—´è¿˜ä¼šæœ‰è‡ªå·±çš„ä¼šè®®å®‰æ’ã€‚å…¬å¸è§„æ¨¡è¿›ä¸€æ­¥æ‰©å±•ï¼Œéœ€è¦å†å¢åŠ ä¸€ä¸ªå±‚çº§ â€”â€” éƒ¨é—¨ï¼Œæ¯ä¸ªéƒ¨é—¨ä¼šä»ç»„é•¿åˆ—è¡¨ä¸­æ¨é€‰å‡ºä¸€ä¸ªä»£è¡¨æ¥ä½œä¸ºéƒ¨é•¿ã€‚éƒ¨é•¿ä»¬ä¹‹é—´è¿˜ä¼šæœ‰è‡ªå·±çš„é«˜å±‚ä¼šè®®å®‰æ’ã€‚ 

è·³è·ƒåˆ—è¡¨å°±æ˜¯ç±»ä¼¼äºè¿™ç§å±‚çº§åˆ¶ï¼Œæœ€ä¸‹é¢ä¸€å±‚æ‰€æœ‰çš„å…ƒç´ éƒ½ä¼šä¸²èµ·æ¥ã€‚ç„¶åæ¯éš”å‡ ä¸ªå…ƒç´ æŒ‘é€‰å‡ºä¸€ä¸ªä»£è¡¨æ¥ï¼Œå†å°†è¿™å‡ ä¸ªä»£è¡¨ä½¿ç”¨å¦å¤–ä¸€çº§æŒ‡é’ˆä¸²èµ·æ¥ã€‚ç„¶ååœ¨è¿™äº›ä»£è¡¨é‡Œå†æŒ‘å‡ºäºŒçº§ä»£è¡¨ï¼Œå†ä¸²èµ·æ¥ã€‚æœ€ç»ˆå°±å½¢æˆäº†é‡‘å­—å¡”ç»“æ„ã€‚

 æƒ³æƒ³ä½ è€å®¶åœ¨ä¸–ç•Œåœ°å›¾ä¸­çš„ä½ç½®ï¼šäºšæ´²-->ä¸­å›½->å®‰å¾½çœ->å®‰åº†å¸‚->æé˜³å¿->æ±¤æ²Ÿé•‡->ç”°é—´æ‘->xxxxå·ï¼Œä¹Ÿæ˜¯è¿™æ ·ä¸€ä¸ªç±»ä¼¼çš„ç»“æ„ã€‚

![](A1CD0483-0365-4E5A-A7F4-A3A45355EF04.png)

ã€Œè·³è·ƒåˆ—è¡¨ã€ä¹‹æ‰€ä»¥ã€Œè·³è·ƒã€ï¼Œæ˜¯å› ä¸ºå†…éƒ¨çš„å…ƒç´ å¯èƒ½ã€Œèº«å…¼æ•°èŒã€ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­é—´çš„è¿™ä¸ªå…ƒç´ ï¼ŒåŒæ—¶å¤„äº L0ã€L1 å’Œ L2 å±‚ï¼Œå¯ä»¥å¿«é€Ÿåœ¨ä¸åŒå±‚æ¬¡ä¹‹é—´è¿›è¡Œã€Œè·³è·ƒã€ã€‚ 

å®šä½æ’å…¥ç‚¹æ—¶ï¼Œå…ˆåœ¨é¡¶å±‚è¿›è¡Œå®šä½ï¼Œç„¶åä¸‹æ½œåˆ°ä¸‹ä¸€çº§å®šä½ï¼Œä¸€ç›´ä¸‹æ½œåˆ°æœ€åº•å±‚æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œå°†æ–°å…ƒç´ æ’è¿›å»ã€‚ä½ ä¹Ÿè®¸ä¼šé—®ï¼Œé‚£æ–°æ’å…¥çš„å…ƒç´ å¦‚ä½•æ‰æœ‰æœºä¼šã€Œèº«å…¼æ•°èŒã€å‘¢ï¼Ÿ 

è·³è·ƒåˆ—è¡¨é‡‡å–ä¸€ä¸ªéšæœºç­–ç•¥æ¥å†³å®šæ–°å…ƒç´ å¯ä»¥å…¼èŒåˆ°ç¬¬å‡ å±‚ã€‚ 

é¦–å…ˆ L0 å±‚è‚¯å®šæ˜¯ 100% äº†ï¼ŒL1 å±‚åªæœ‰ 50% çš„æ¦‚ç‡ï¼ŒL2 å±‚åªæœ‰ 25% çš„æ¦‚ç‡ï¼ŒL3 å±‚åªæœ‰ 12.5% çš„æ¦‚ç‡ï¼Œä¸€ç›´éšæœºåˆ°æœ€é¡¶å±‚ L31 å±‚ã€‚ç»å¤§å¤šæ•°å…ƒç´ éƒ½è¿‡ä¸äº†å‡ å±‚ï¼Œåªæœ‰æå°‘æ•°å…ƒç´ å¯ä»¥æ·±å…¥åˆ°é¡¶å±‚ã€‚åˆ—è¡¨ä¸­çš„å…ƒç´ è¶Šå¤šï¼Œèƒ½å¤Ÿæ·±å…¥çš„å±‚æ¬¡å°±è¶Šæ·±ï¼Œèƒ½è¿›å…¥åˆ°é¡¶å±‚çš„æ¦‚ç‡å°±ä¼šè¶Šå¤§ã€‚ 

## å®¹å™¨å‹æ•°æ®ç»“æ„çš„é€šç”¨è§„åˆ™

list/set/hash/zset è¿™å››ç§æ•°æ®ç»“æ„æ˜¯å®¹å™¨å‹æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å…±äº«ä¸‹é¢ä¸¤æ¡é€šç”¨è§„åˆ™ï¼š

1ã€create if not exists 

å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªï¼Œå†è¿›è¡Œæ“ä½œã€‚æ¯”å¦‚ rpush æ“ä½œåˆšå¼€å§‹æ˜¯æ²¡æœ‰åˆ—è¡¨çš„ï¼ŒRedis å°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªï¼Œç„¶åå† rpush è¿›å»æ–°å…ƒç´ ã€‚ 

2ã€drop if no elements 

å¦‚æœå®¹å™¨é‡Œå…ƒç´ æ²¡æœ‰äº†ï¼Œé‚£ä¹ˆç«‹å³åˆ é™¤å…ƒç´ ï¼Œé‡Šæ”¾å†…å­˜ã€‚è¿™æ„å‘³ç€ lpop æ“ä½œåˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ—è¡¨å°±æ¶ˆå¤±äº†ã€‚

## è¿‡æœŸæ—¶é—´

Redis æ‰€æœ‰çš„æ•°æ®ç»“æ„éƒ½å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ—¶é—´åˆ°äº†ï¼ŒRedis ä¼šè‡ªåŠ¨åˆ é™¤ç›¸åº”çš„å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿‡æœŸæ˜¯ä»¥å¯¹è±¡ä¸ºå•ä½ï¼Œæ¯”å¦‚ä¸€ä¸ª hash ç»“æ„çš„è¿‡æœŸæ˜¯æ•´ä¸ª hash å¯¹è±¡çš„è¿‡æœŸï¼Œè€Œä¸æ˜¯å…¶ä¸­çš„æŸä¸ªå­ keyã€‚

è¿˜æœ‰ä¸€ä¸ªéœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹æ˜¯å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²å·²ç»è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œç„¶åä½ è°ƒç”¨äº† set æ–¹æ³•ä¿®æ”¹äº†å®ƒï¼Œå®ƒçš„è¿‡æœŸæ—¶é—´ä¼šæ¶ˆå¤±ã€‚

```assembly
127.0.0.1:6379> set codehole yoyo
OK
127.0.0.1:6379> expire codehole 600
(integer) 1
127.0.0.1:6379> ttl codehole
(integer) 597
127.0.0.1:6379> set codehole yoyo
OK
127.0.0.1:6379> ttl codehole
(integer) -1
```

# ä¸‰ã€åº”ç”¨1 åˆ†å¸ƒå¼é”

åˆ†å¸ƒå¼åº”ç”¨è¿›è¡Œé€»è¾‘å¤„ç†æ—¶ç»å¸¸ä¼šé‡åˆ°å¹¶å‘é—®é¢˜ã€‚ 

æ¯”å¦‚ä¸€ä¸ªæ“ä½œè¦ä¿®æ”¹ç”¨æˆ·çš„çŠ¶æ€ï¼Œä¿®æ”¹çŠ¶æ€éœ€è¦å…ˆè¯»å‡ºç”¨æˆ·çš„çŠ¶æ€ï¼Œåœ¨å†…å­˜é‡Œè¿›è¡Œä¿®æ”¹ï¼Œæ”¹å®Œäº†å†å­˜å›å»ã€‚å¦‚æœè¿™æ ·çš„æ“ä½œåŒæ—¶è¿›è¡Œäº†ï¼Œå°±ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºè¯»å–å’Œä¿å­˜çŠ¶æ€è¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ã€‚ï¼ˆWiki è§£é‡Šï¼šæ‰€è°“åŸå­æ“ä½œæ˜¯æŒ‡ä¸ä¼šè¢«çº¿ç¨‹è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼›è¿™ç§æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°ç»“æŸï¼Œä¸­é—´ä¸ä¼šæœ‰ä»»ä½• context switch çº¿ç¨‹åˆ‡æ¢ã€‚ï¼‰

![](19B3BB50-AD9F-48ED-90AA-C36E3B41CB03.png)

è¿™ä¸ªæ—¶å€™å°±è¦ä½¿ç”¨åˆ°åˆ†å¸ƒå¼é”æ¥é™åˆ¶ç¨‹åºçš„å¹¶å‘æ‰§è¡Œã€‚Redis åˆ†å¸ƒå¼é”ä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œå®ƒæ˜¯é¢è¯•çš„é‡è¦è€ƒç‚¹ä¹‹ä¸€ï¼Œå¾ˆå¤šåŒå­¦éƒ½çŸ¥é“è¿™ä¸ªçŸ¥è¯†ï¼Œä¹Ÿå¤§è‡´çŸ¥é“åˆ†å¸ƒå¼é”çš„åŸç†ï¼Œä½†æ˜¯å…·ä½“åˆ°ç»†èŠ‚çš„ä½¿ç”¨ä¸Šå¾€å¾€å¹¶ä¸å®Œå…¨æ­£ç¡®ã€‚

## **åˆ†å¸ƒå¼é”**

åˆ†å¸ƒå¼é”æœ¬è´¨ä¸Šè¦å®ç°çš„ç›®æ ‡å°±æ˜¯åœ¨ Redis é‡Œé¢å ä¸€ä¸ªâ€œèŒ…å‘â€ï¼Œå½“åˆ«çš„è¿›ç¨‹ä¹Ÿè¦æ¥å æ—¶ï¼Œå‘ç°å·²ç»æœ‰äººè¹²åœ¨é‚£é‡Œäº†ï¼Œå°±åªå¥½æ”¾å¼ƒæˆ–è€…ç¨åå†è¯•ã€‚

å å‘ä¸€èˆ¬æ˜¯ä½¿ç”¨ setnx(set if not exists) æŒ‡ä»¤ï¼Œåªå…è®¸è¢«ä¸€ä¸ªå®¢æˆ·ç«¯å å‘ã€‚å…ˆæ¥å…ˆå ï¼Œ ç”¨å®Œäº†ï¼Œå†è°ƒç”¨ del æŒ‡ä»¤é‡Šæ”¾èŒ…å‘ã€‚

```assembly
// è¿™é‡Œçš„å†’å·:å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å­—ç¬¦ï¼Œæ²¡ç‰¹åˆ«å«ä¹‰ï¼Œå®ƒå¯ä»¥æ˜¯ä»»æ„å…¶å®ƒå­—ç¬¦ï¼Œä¸è¦è¯¯è§£
> setnx lock:codehole true
OK
... do something critical ...
> del lock:codehole
(integer) 1
```

ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœé€»è¾‘æ‰§è¡Œåˆ°ä¸­é—´å‡ºç°å¼‚å¸¸äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´ del æŒ‡ä»¤æ²¡æœ‰è¢«è°ƒç”¨ï¼Œè¿™æ ·å°±ä¼šé™·å…¥æ­»é”ï¼Œé”æ°¸è¿œå¾—ä¸åˆ°é‡Šæ”¾ã€‚

äºæ˜¯æˆ‘ä»¬åœ¨æ‹¿åˆ°é”ä¹‹åï¼Œå†ç»™é”åŠ ä¸Šä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚ 5sï¼Œè¿™æ ·å³ä½¿ä¸­é—´å‡ºç°å¼‚å¸¸ä¹Ÿå¯ä»¥ä¿è¯ 5 ç§’ä¹‹åé”ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚

```assembly
> setnx lock:codehole true
OK
> expire lock:codehole 5
... do something critical ...
> del lock:codehole
(integer) 1
```

ä½†æ˜¯ä»¥ä¸Šé€»è¾‘è¿˜æœ‰é—®é¢˜ã€‚å¦‚æœåœ¨ setnx å’Œ expire ä¹‹é—´æœåŠ¡å™¨è¿›ç¨‹çªç„¶æŒ‚æ‰äº†ï¼Œå¯èƒ½æ˜¯å› ä¸ºæœºå™¨æ‰ç”µæˆ–è€…æ˜¯è¢«äººä¸ºæ€æ‰çš„ï¼Œå°±ä¼šå¯¼è‡´ expire å¾—ä¸åˆ°æ‰§è¡Œï¼Œä¹Ÿä¼šé€ æˆæ­»é”ã€‚

è¿™ç§é—®é¢˜çš„æ ¹æºå°±åœ¨äº setnx å’Œ expire æ˜¯ä¸¤æ¡æŒ‡ä»¤è€Œä¸æ˜¯åŸå­æŒ‡ä»¤ã€‚å¦‚æœè¿™ä¸¤æ¡æŒ‡ä»¤å¯ä»¥ä¸€èµ·æ‰§è¡Œå°±ä¸ä¼šå‡ºç°é—®é¢˜ã€‚ä¹Ÿè®¸ä½ ä¼šæƒ³åˆ°ç”¨ Redis äº‹åŠ¡æ¥è§£å†³ã€‚ä½†æ˜¯è¿™é‡Œä¸è¡Œï¼Œå› ä¸º expire æ˜¯ä¾èµ–äº setnx çš„æ‰§è¡Œç»“æœçš„ï¼Œå¦‚æœ setnx æ²¡æŠ¢åˆ°é”ï¼Œexpire æ˜¯ä¸åº”è¯¥æ‰§è¡Œçš„ã€‚äº‹åŠ¡é‡Œæ²¡æœ‰ if-else åˆ†æ”¯é€»è¾‘ï¼Œäº‹åŠ¡çš„ç‰¹ç‚¹æ˜¯ä¸€å£æ°”æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªç–‘éš¾ï¼ŒRedis å¼€æºç¤¾åŒºæ¶Œç°äº†ä¸€å †åˆ†å¸ƒå¼é”çš„ libraryï¼Œä¸“é—¨ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ç°æ–¹æ³•æä¸ºå¤æ‚ï¼Œå°ç™½ç”¨æˆ·ä¸€èˆ¬è¦è´¹å¾ˆå¤§çš„ç²¾åŠ›æ‰å¯ä»¥ææ‡‚ã€‚å¦‚æœä½ éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œæ„å‘³ç€ä½ ä¸èƒ½ä»…ä»…ä½¿ç”¨ Jedis æˆ–è€… redis-py å°±è¡Œäº†ï¼Œè¿˜å¾—å¼•å…¥åˆ†å¸ƒå¼é”çš„ libraryã€‚

![](16459b393843f7ae)

ä¸ºäº†æ²»ç†è¿™ä¸ªä¹±è±¡ï¼ŒRedis 2.8 ç‰ˆæœ¬ä¸­ä½œè€…åŠ å…¥äº† set æŒ‡ä»¤çš„æ‰©å±•å‚æ•°ï¼Œä½¿å¾— setnx å’Œ expire æŒ‡ä»¤å¯ä»¥ä¸€èµ·æ‰§è¡Œï¼Œå½»åº•è§£å†³äº†åˆ†å¸ƒå¼é”çš„ä¹±è±¡ã€‚ä»æ­¤ä»¥åæ‰€æœ‰çš„ç¬¬ä¸‰æ–¹åˆ†å¸ƒå¼é” library å¯ä»¥ä¼‘æ¯äº†ã€‚

```assembly
> set lock:codehole true ex 5 nx
OK
... do something critical ...
> del lock:codehole
```

## è¶…æ—¶é—®é¢˜

Redis çš„åˆ†å¸ƒå¼é”ä¸èƒ½è§£å†³è¶…æ—¶é—®é¢˜ï¼Œå¦‚æœåœ¨åŠ é”å’Œé‡Šæ”¾é”ä¹‹é—´çš„é€»è¾‘æ‰§è¡Œçš„å¤ªé•¿ï¼Œä»¥è‡³äºè¶…å‡ºäº†é”çš„è¶…æ—¶é™åˆ¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚å› ä¸ºè¿™æ—¶å€™é”è¿‡æœŸäº†ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹é‡æ–°æŒæœ‰äº†è¿™æŠŠé”ï¼Œä½†æ˜¯ç´§æ¥ç€ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œäº†ä¸šåŠ¡é€»è¾‘ï¼Œå°±æŠŠé”ç»™é‡Šæ”¾äº†ï¼Œç¬¬ä¸‰ä¸ªçº¿ç¨‹å°±ä¼šåœ¨ç¬¬äºŒä¸ªçº¿ç¨‹é€»è¾‘æ‰§è¡Œå®Œä¹‹é—´æ‹¿åˆ°äº†é”ã€‚

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼ŒRedis åˆ†å¸ƒå¼é”ä¸è¦ç”¨äºè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ã€‚å¦‚æœçœŸçš„å¶å°”å‡ºç°äº†ï¼Œæ•°æ®å‡ºç°çš„å°æ³¢é”™ä¹±å¯èƒ½éœ€è¦äººå·¥ä»‹å…¥è§£å†³ã€‚

```assembly
tag = random.nextint()  # éšæœºæ•°
if redis.set(key, tag, nx=True, ex=5):
    do_something()
    redis.delifequals(key, tag)  # å‡æƒ³çš„ delifequals æŒ‡ä»¤
```

æœ‰ä¸€ä¸ªç¨å¾®å®‰å…¨ä¸€ç‚¹çš„æ–¹æ¡ˆæ˜¯ä¸º set æŒ‡ä»¤çš„ value å‚æ•°è®¾ç½®ä¸ºä¸€ä¸ªéšæœºæ•°ï¼Œé‡Šæ”¾é”æ—¶å…ˆåŒ¹é…éšæœºæ•°æ˜¯å¦ä¸€è‡´ï¼Œç„¶åå†åˆ é™¤ keyï¼Œè¿™æ˜¯ä¸ºäº†ç¡®ä¿å½“å‰çº¿ç¨‹å æœ‰çš„é”ä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹é‡Šæ”¾ï¼Œé™¤éè¿™ä¸ªé”æ˜¯è¿‡æœŸäº†è¢«æœåŠ¡å™¨è‡ªåŠ¨é‡Šæ”¾çš„ã€‚ ä½†æ˜¯åŒ¹é… value å’Œåˆ é™¤ key ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼ŒRedis ä¹Ÿæ²¡æœ‰æä¾›ç±»ä¼¼äºdelifequalsè¿™æ ·çš„æŒ‡ä»¤ï¼Œè¿™å°±éœ€è¦ä½¿ç”¨ Lua è„šæœ¬æ¥å¤„ç†äº†ï¼Œå› ä¸º Lua è„šæœ¬å¯ä»¥ä¿è¯è¿ç»­å¤šä¸ªæŒ‡ä»¤çš„åŸå­æ€§æ‰§è¡Œã€‚

```assembly
# delifequals
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```

## å¯é‡å…¥æ€§

å¯é‡å…¥æ€§æ˜¯æŒ‡çº¿ç¨‹åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹å†æ¬¡è¯·æ±‚åŠ é”ï¼Œå¦‚æœä¸€ä¸ªé”æ”¯æŒåŒä¸€ä¸ªçº¿ç¨‹çš„å¤šæ¬¡åŠ é”ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°±æ˜¯å¯é‡å…¥çš„ã€‚æ¯”å¦‚ Java è¯­è¨€é‡Œæœ‰ä¸ª ReentrantLock å°±æ˜¯å¯é‡å…¥é”ã€‚Redis åˆ†å¸ƒå¼é”å¦‚æœè¦æ”¯æŒå¯é‡å…¥ï¼Œéœ€è¦å¯¹å®¢æˆ·ç«¯çš„ set æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œä½¿ç”¨çº¿ç¨‹çš„ Threadlocal å˜é‡å­˜å‚¨å½“å‰æŒæœ‰é”çš„è®¡æ•°ã€‚

```python
# -*- coding: utf-8
import redis
import threading


locks = threading.local()
locks.redis = {}

def key_for(user_id):
    return "account_{}".format(user_id)

def _lock(client, key):
    return bool(client.set(key, True, nx=True, ex=5))

def _unlock(client, key):
    client.delete(key)

def lock(client, user_id):
    key = key_for(user_id)
    if key in locks.redis:
        locks.redis[key] += 1
        return True
    ok = _lock(client, key)
    if not ok:
        return False
    locks.redis[key] = 1
    return True

def unlock(client, user_id):
    key = key_for(user_id)
    if key in locks.redis:
        locks.redis[key] -= 1
        if locks.redis[key] <= 0:
            del locks.redis[key]
        return True
    return False

client = redis.StrictRedis()
print "lock", lock(client, "codehole")
print "lock", lock(client, "codehole")
print "unlock", unlock(client, "codehole")
print "unlock", unlock(client, "codehole")
```

ä»¥ä¸Šè¿˜ä¸æ˜¯å¯é‡å…¥é”çš„å…¨éƒ¨ï¼Œç²¾ç¡®ä¸€ç‚¹è¿˜éœ€è¦è€ƒè™‘å†…å­˜é”è®¡æ•°çš„è¿‡æœŸæ—¶é—´ï¼Œä»£ç å¤æ‚åº¦å°†ä¼šç»§ç»­å‡é«˜ã€‚è€é’±ä¸æ¨èä½¿ç”¨å¯é‡å…¥é”ï¼Œå®ƒåŠ é‡äº†å®¢æˆ·ç«¯çš„å¤æ‚æ€§ï¼Œåœ¨ç¼–å†™ä¸šåŠ¡æ–¹æ³•æ—¶æ³¨æ„åœ¨é€»è¾‘ç»“æ„ä¸Šè¿›è¡Œè°ƒæ•´å®Œå…¨å¯ä»¥ä¸ä½¿ç”¨å¯é‡å…¥é”ã€‚ä¸‹é¢æ˜¯ Java ç‰ˆæœ¬çš„å¯é‡å…¥é”ã€‚

```java
public class RedisWithReentrantLock {

  private ThreadLocal<Map<String, Integer>> lockers = new ThreadLocal<>();

  private Jedis jedis;

  public RedisWithReentrantLock(Jedis jedis) {
    this.jedis = jedis;
  }

  private boolean _lock(String key) {
    return jedis.set(key, "", "nx", "ex", 5L) != null;
  }

  private void _unlock(String key) {
    jedis.del(key);
  }

  private Map<String, Integer> currentLockers() {
    Map<String, Integer> refs = lockers.get();
    if (refs != null) {
      return refs;
    }
    lockers.set(new HashMap<>());
    return lockers.get();
  }

  public boolean lock(String key) {
    Map<String, Integer> refs = currentLockers();
    Integer refCnt = refs.get(key);
    if (refCnt != null) {
      refs.put(key, refCnt + 1);
      return true;
    }
    boolean ok = this._lock(key);
    if (!ok) {
      return false;
    }
    refs.put(key, 1);
    return true;
  }

  public boolean unlock(String key) {
    Map<String, Integer> refs = currentLockers();
    Integer refCnt = refs
        lockers.set(new HashMap<>());
    return lockers.get();
  }

  public boolean lock(String key) {
    Map<String, Integer> refs = currentLockers();
    Integer refCnt = refs.get(key);
    if (refCnt != null) {
      refs.put(key, refCnt + 1);
      return true;
    }
    boolean ok = this._lock(key);
    if (!ok) {
      return false;
    }
    refs.put(key, 1);
    return true;
  }

  public boolean unlock(String key) {
    Map<String, Integer> refs = currentLockers();
    Integer refCnt = refs.get(key);
    if (refCnt == null) {
      return false;
    }
    refCnt -= 1;
    if (refCnt > 0) {
      refs.put(key, refCnt);
    } else {
      refs.remove(key);
      this._unlock(key);
    }
    return true;
  }

  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    RedisWithReentrantLock redis = new RedisWithReentrantLock(jedis);
    System.out.println(redis.lock("codehole"));
    System.out.println(redis.lock("codehole"));
    System.out.println(redis.unlock("codehole"));
    System.out.println(redis.unlock("codehole"));
  }

}
```

# å››ã€åº”ç”¨2 å»¶æ—¶é˜Ÿåˆ—

æˆ‘ä»¬å¹³æ—¶ä¹ æƒ¯äºä½¿ç”¨ Rabbitmq å’Œ Kafka ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œæ¥ç»™åº”ç”¨ç¨‹åºä¹‹é—´å¢åŠ å¼‚æ­¥æ¶ˆæ¯ä¼ é€’åŠŸèƒ½ã€‚è¿™ä¸¤ä¸ªä¸­é—´ä»¶éƒ½æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œç‰¹æ€§ä¹‹å¤šè¶…å‡ºäº†å¤§å¤šæ•°äººçš„ç†è§£èƒ½åŠ›ã€‚

ä½¿ç”¨è¿‡ Rabbitmq çš„åŒå­¦çŸ¥é“å®ƒä½¿ç”¨èµ·æ¥æœ‰å¤šå¤æ‚ï¼Œå‘æ¶ˆæ¯ä¹‹å‰è¦åˆ›å»º Exchangeï¼Œå†åˆ›å»º Queueï¼Œè¿˜è¦å°† Queue å’Œ Exchange é€šè¿‡æŸç§è§„åˆ™ç»‘å®šèµ·æ¥ï¼Œå‘æ¶ˆæ¯çš„æ—¶å€™è¦æŒ‡å®š routing-keyï¼Œè¿˜è¦æ§åˆ¶å¤´éƒ¨ä¿¡æ¯ã€‚æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ¶ˆæ¯ä¹‹å‰ä¹Ÿè¦è¿›è¡Œä¸Šé¢ä¸€ç³»åˆ—çš„ç¹çè¿‡ç¨‹ã€‚ä½†æ˜¯ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè™½ç„¶æˆ‘ä»¬çš„æ¶ˆæ¯é˜Ÿåˆ—åªæœ‰ä¸€ç»„æ¶ˆè´¹è€…ï¼Œä½†è¿˜æ˜¯éœ€è¦ç»å†ä¸Šé¢è¿™äº›ç¹ççš„è¿‡ç¨‹ã€‚

æœ‰äº† Redisï¼Œå®ƒå°±å¯ä»¥è®©æˆ‘ä»¬è§£è„±å‡ºæ¥ï¼Œå¯¹äºé‚£äº›åªæœ‰ä¸€ç»„æ¶ˆè´¹è€…çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½¿ç”¨ Redis å°±å¯ä»¥éå¸¸è½»æ¾çš„æå®šã€‚Redis çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒæ²¡æœ‰éå¸¸å¤šçš„é«˜çº§ç‰¹æ€§ï¼Œæ²¡æœ‰ ack ä¿è¯ï¼Œå¦‚æœå¯¹æ¶ˆæ¯çš„å¯é æ€§æœ‰ç€æè‡´çš„è¿½æ±‚ï¼Œé‚£ä¹ˆå®ƒå°±ä¸é€‚åˆä½¿ç”¨ã€‚

## å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—

Redis çš„ list(åˆ—è¡¨) æ•°æ®ç»“æ„å¸¸ç”¨æ¥ä½œä¸ºå¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼Œä½¿ç”¨`rpush/lpush`æ“ä½œå…¥é˜Ÿåˆ—ï¼Œä½¿ç”¨`lpop å’Œ rpop`æ¥å‡ºé˜Ÿåˆ—ã€‚

![](CA5FE297-2973-4736-BF93-9DA944DF1968.png)

```assembly
> rpush notify-queue apple banana pear
(integer) 3
> llen notify-queue
(integer) 3
> lpop notify-queue
"apple"
> llen notify-queue
(integer) 2
> lpop notify-queue
"banana"
> llen notify-queue
(integer) 1
> lpop notify-queue
"pear"
> llen notify-queue
(integer) 0
> lpop notify-queue
(nil)
```

ä¸Šé¢æ˜¯ rpush å’Œ lpop ç»“åˆä½¿ç”¨çš„ä¾‹å­ã€‚è¿˜å¯ä»¥ä½¿ç”¨ lpush å’Œ rpop ç»“åˆä½¿ç”¨ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚è¿™é‡Œä¸å†èµ˜è¿°ã€‚

## é˜Ÿåˆ—ç©ºäº†æ€ä¹ˆåŠï¼Ÿ

å®¢æˆ·ç«¯æ˜¯é€šè¿‡é˜Ÿåˆ—çš„ pop æ“ä½œæ¥è·å–æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œäº†å†æ¥ç€è·å–æ¶ˆæ¯ï¼Œå†è¿›è¡Œå¤„ç†ã€‚å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œè¿™ä¾¿æ˜¯ä½œä¸ºé˜Ÿåˆ—æ¶ˆè´¹è€…çš„å®¢æˆ·ç«¯çš„ç”Ÿå‘½å‘¨æœŸã€‚

å¯æ˜¯å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œå®¢æˆ·ç«¯å°±ä¼šé™·å…¥ pop çš„æ­»å¾ªç¯ï¼Œä¸åœåœ° popï¼Œæ²¡æœ‰æ•°æ®ï¼Œæ¥ç€å† popï¼Œåˆæ²¡æœ‰æ•°æ®ã€‚è¿™å°±æ˜¯æµªè´¹ç”Ÿå‘½çš„ç©ºè½®è¯¢ã€‚ç©ºè½®è¯¢ä¸ä½†æ‹‰é«˜äº†å®¢æˆ·ç«¯çš„ CPUï¼Œredis çš„ QPS ä¹Ÿä¼šè¢«æ‹‰é«˜ï¼Œå¦‚æœè¿™æ ·ç©ºè½®è¯¢çš„å®¢æˆ·ç«¯æœ‰å‡ åæ¥ä¸ªï¼ŒRedis çš„æ…¢æŸ¥è¯¢å¯èƒ½ä¼šæ˜¾è‘—å¢å¤šã€‚

é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ sleep æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©çº¿ç¨‹ç¡ä¸€ä¼šï¼Œç¡ä¸ª 1s é’Ÿå°±å¯ä»¥äº†ã€‚ä¸ä½†å®¢æˆ·ç«¯çš„ CPU èƒ½é™ä¸‹æ¥ï¼ŒRedis çš„ QPS ä¹Ÿé™ä¸‹æ¥äº†ã€‚

```assembly
time.sleep(1)  # python ç¡ 1s
Thread.sleep(1000)  # java ç¡ 1s
```

![](E9A04A72-A828-424F-91A7-E9A3A51FE58F.png)

## é˜Ÿåˆ—å»¶è¿Ÿ

ç”¨ä¸Šé¢ç¡çœ çš„åŠæ³•å¯ä»¥è§£å†³é—®é¢˜ã€‚ä½†æ˜¯æœ‰ä¸ªå°é—®é¢˜ï¼Œé‚£å°±æ˜¯ç¡çœ ä¼šå¯¼è‡´æ¶ˆæ¯çš„å»¶è¿Ÿå¢å¤§ã€‚å¦‚æœåªæœ‰ 1 ä¸ªæ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆè¿™ä¸ªå»¶è¿Ÿå°±æ˜¯ 1sã€‚å¦‚æœæœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œè¿™ä¸ªå»¶è¿Ÿä¼šæœ‰æ‰€ä¸‹é™ï¼Œå› ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…çš„ç¡è§‰æ—¶é—´æ˜¯å²”å¼€æ¥çš„ã€‚

æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•èƒ½æ˜¾è‘—é™ä½å»¶è¿Ÿå‘¢ï¼Ÿä½ å½“ç„¶å¯ä»¥å¾ˆå¿«æƒ³åˆ°ï¼šé‚£å°±æŠŠç¡è§‰çš„æ—¶é—´ç¼©çŸ­ç‚¹ã€‚è¿™ç§æ–¹å¼å½“ç„¶å¯ä»¥ï¼Œä¸è¿‡æœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿå½“ç„¶ä¹Ÿæœ‰ï¼Œé‚£å°±æ˜¯ blpop/brpopã€‚

è¿™ä¸¤ä¸ªæŒ‡ä»¤çš„å‰ç¼€å­—ç¬¦bä»£è¡¨çš„æ˜¯blockingï¼Œä¹Ÿå°±æ˜¯é˜»å¡è¯»ã€‚

é˜»å¡è¯»åœ¨é˜Ÿåˆ—æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œä¼šç«‹å³è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œä¸€æ—¦æ•°æ®åˆ°æ¥ï¼Œåˆ™ç«‹åˆ»é†’è¿‡æ¥ã€‚æ¶ˆæ¯çš„å»¶è¿Ÿå‡ ä¹ä¸ºé›¶ã€‚ç”¨blpop/brpopæ›¿ä»£å‰é¢çš„lpop/rpopï¼Œå°±å®Œç¾è§£å†³äº†ä¸Šé¢çš„é—®é¢˜ã€‚

## ç©ºé—²è¿æ¥è‡ªåŠ¨æ–­å¼€

ä½ ä»¥ä¸ºä¸Šé¢çš„æ–¹æ¡ˆçœŸçš„å¾ˆå®Œç¾ä¹ˆï¼Ÿå…ˆåˆ«æ€¥ç€å¼€å¿ƒï¼Œå…¶å®ä»–è¿˜æœ‰ä¸ªé—®é¢˜éœ€è¦è§£å†³ã€‚

ä»€ä¹ˆé—®é¢˜ï¼Ÿâ€”â€” ç©ºé—²è¿æ¥çš„é—®é¢˜ã€‚

å¦‚æœçº¿ç¨‹ä¸€ç›´é˜»å¡åœ¨å“ªé‡Œï¼ŒRedis çš„å®¢æˆ·ç«¯è¿æ¥å°±æˆäº†é—²ç½®è¿æ¥ï¼Œé—²ç½®è¿‡ä¹…ï¼ŒæœåŠ¡å™¨ä¸€èˆ¬ä¼šä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œå‡å°‘é—²ç½®èµ„æºå ç”¨ã€‚è¿™ä¸ªæ—¶å€™blpop/brpopä¼šæŠ›å‡ºå¼‚å¸¸æ¥ã€‚

æ‰€ä»¥ç¼–å†™å®¢æˆ·ç«¯æ¶ˆè´¹è€…çš„æ—¶å€™è¦å°å¿ƒï¼Œæ³¨æ„æ•è·å¼‚å¸¸ï¼Œè¿˜è¦é‡è¯•ã€‚

## é”å†²çªå¤„ç†

ä¸ŠèŠ‚è¯¾æˆ‘ä»¬è®²äº†åˆ†å¸ƒå¼é”çš„é—®é¢˜ï¼Œä½†æ˜¯æ²¡æœ‰æåˆ°å®¢æˆ·ç«¯åœ¨å¤„ç†è¯·æ±‚æ—¶åŠ é”æ²¡åŠ æˆåŠŸæ€ä¹ˆåŠã€‚ä¸€èˆ¬æœ‰ 3 ç§ç­–ç•¥æ¥å¤„ç†åŠ é”å¤±è´¥ï¼š

1. ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé€šçŸ¥ç”¨æˆ·ç¨åé‡è¯•ï¼›
2. sleep ä¸€ä¼šå†é‡è¯•ï¼›
3. å°†è¯·æ±‚è½¬ç§»è‡³å»¶æ—¶é˜Ÿåˆ—ï¼Œè¿‡ä¸€ä¼šå†è¯•ï¼›

**ç›´æ¥æŠ›å‡ºç‰¹å®šç±»å‹çš„å¼‚å¸¸**

è¿™ç§æ–¹å¼æ¯”è¾ƒé€‚åˆç”±ç”¨æˆ·ç›´æ¥å‘èµ·çš„è¯·æ±‚ï¼Œç”¨æˆ·çœ‹åˆ°é”™è¯¯å¯¹è¯æ¡†åï¼Œä¼šå…ˆé˜…è¯»å¯¹è¯æ¡†çš„å†…å®¹ï¼Œå†ç‚¹å‡»é‡è¯•ï¼Œè¿™æ ·å°±å¯ä»¥èµ·åˆ°äººå·¥å»¶æ—¶çš„æ•ˆæœã€‚å¦‚æœè€ƒè™‘åˆ°ç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥ç”±å‰ç«¯çš„ä»£ç æ›¿ä»£ç”¨æˆ·è‡ªå·±æ¥è¿›è¡Œå»¶æ—¶é‡è¯•æ§åˆ¶ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯å¯¹å½“å‰è¯·æ±‚çš„æ”¾å¼ƒï¼Œç”±ç”¨æˆ·å†³å®šæ˜¯å¦é‡æ–°å‘èµ·æ–°çš„è¯·æ±‚ã€‚

**sleep**

sleep ä¼šé˜»å¡å½“å‰çš„æ¶ˆæ¯å¤„ç†çº¿ç¨‹ï¼Œä¼šå¯¼è‡´é˜Ÿåˆ—çš„åç»­æ¶ˆæ¯å¤„ç†å‡ºç°å»¶è¿Ÿã€‚å¦‚æœç¢°æ’çš„æ¯”è¾ƒé¢‘ç¹æˆ–è€…é˜Ÿåˆ—é‡Œæ¶ˆæ¯æ¯”è¾ƒå¤šï¼Œsleep å¯èƒ½å¹¶ä¸åˆé€‚ã€‚å¦‚æœå› ä¸ºä¸ªåˆ«æ­»é”çš„ key å¯¼è‡´åŠ é”ä¸æˆåŠŸï¼Œçº¿ç¨‹ä¼šå½»åº•å µæ­»ï¼Œå¯¼è‡´åç»­æ¶ˆæ¯æ°¸è¿œå¾—ä¸åˆ°åŠæ—¶å¤„ç†ã€‚

å»¶æ—¶é˜Ÿåˆ—

è¿™ç§æ–¹å¼æ¯”è¾ƒé€‚åˆå¼‚æ­¥æ¶ˆæ¯å¤„ç†ï¼Œå°†å½“å‰å†²çªçš„è¯·æ±‚æ‰”åˆ°å¦ä¸€ä¸ªé˜Ÿåˆ—å»¶åå¤„ç†ä»¥é¿å¼€å†²çªã€‚

## å»¶æ—¶é˜Ÿåˆ—çš„å®ç°

å»¶æ—¶é˜Ÿåˆ—å¯ä»¥é€šè¿‡ Redis çš„ zset(æœ‰åºåˆ—è¡¨) æ¥å®ç°ã€‚æˆ‘ä»¬å°†æ¶ˆæ¯åºåˆ—åŒ–æˆä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º zset çš„valueï¼Œè¿™ä¸ªæ¶ˆæ¯çš„åˆ°æœŸå¤„ç†æ—¶é—´ä½œä¸ºscoreï¼Œç„¶åç”¨å¤šä¸ªçº¿ç¨‹è½®è¯¢ zset è·å–åˆ°æœŸçš„ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå¤šä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†ä¿éšœå¯ç”¨æ€§ï¼Œä¸‡ä¸€æŒ‚äº†ä¸€ä¸ªçº¿ç¨‹è¿˜æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†ã€‚å› ä¸ºæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘å¹¶å‘äº‰æŠ¢ä»»åŠ¡ï¼Œç¡®ä¿ä»»åŠ¡ä¸èƒ½è¢«å¤šæ¬¡æ‰§è¡Œã€‚

```python
def delay(msg):
    msg.id = str(uuid.uuid4())  # ä¿è¯ value å€¼å”¯ä¸€
    value = json.dumps(msg)
    retry_ts = time.time() + 5  # 5 ç§’åé‡è¯•
    redis.zadd("delay-queue", retry_ts, value)


def loop():
    while True:
        # æœ€å¤šå– 1 æ¡
        values = redis.zrangebyscore("delay-queue", 0, time.time(), start=0, num=1)
        if not values:
            time.sleep(1)  # å»¶æ—¶é˜Ÿåˆ—ç©ºçš„ï¼Œä¼‘æ¯ 1s
            continue
        value = values[0]  # æ‹¿ç¬¬ä¸€æ¡ï¼Œä¹Ÿåªæœ‰ä¸€æ¡
        success = redis.zrem("delay-queue", value)  # ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤è¯¥æ¶ˆæ¯
        if success:  # å› ä¸ºæœ‰å¤šè¿›ç¨‹å¹¶å‘çš„å¯èƒ½ï¼Œæœ€ç»ˆåªä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æŠ¢åˆ°æ¶ˆæ¯
            msg = json.loads(value)
            handle_msg(msg)
```

Redis çš„ zrem æ–¹æ³•æ˜¯å¤šçº¿ç¨‹å¤šè¿›ç¨‹äº‰æŠ¢ä»»åŠ¡çš„å…³é”®ï¼Œå®ƒçš„è¿”å›å€¼å†³å®šäº†å½“å‰å®ä¾‹æœ‰æ²¡æœ‰æŠ¢åˆ°ä»»åŠ¡ï¼Œå› ä¸º loop æ–¹æ³•å¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹ã€å¤šä¸ªè¿›ç¨‹è°ƒç”¨ï¼ŒåŒä¸€ä¸ªä»»åŠ¡å¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹çº¿ç¨‹æŠ¢åˆ°ï¼Œé€šè¿‡ zrem æ¥å†³å®šå”¯ä¸€çš„å±ä¸»ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬è¦æ³¨æ„ä¸€å®šè¦å¯¹ handle_msg è¿›è¡Œå¼‚å¸¸æ•è·ï¼Œé¿å…å› ä¸ºä¸ªåˆ«ä»»åŠ¡å¤„ç†é—®é¢˜å¯¼è‡´å¾ªç¯å¼‚å¸¸é€€å‡ºã€‚ä»¥ä¸‹æ˜¯ Java ç‰ˆæœ¬çš„å»¶æ—¶é˜Ÿåˆ—å®ç°ï¼Œå› ä¸ºè¦ä½¿ç”¨åˆ° Json åºåˆ—åŒ–ï¼Œæ‰€ä»¥è¿˜éœ€è¦ fastjson åº“çš„æ”¯æŒã€‚

```java
import java.lang.reflect.Type;
import java.util.Set;
import java.util.UUID;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.TypeReference;

import redis.clients.jedis.Jedis;

public class RedisDelayingQueue<T> {

  static class TaskItem<T> {
    public String id;
    public T msg;
  }

  // fastjson åºåˆ—åŒ–å¯¹è±¡ä¸­å­˜åœ¨ generic ç±»å‹æ—¶ï¼Œéœ€è¦ä½¿ç”¨ TypeReference
  private Type TaskType = new TypeReference<TaskItem<T>>() {
  }.getType();

  private Jedis jedis;
  private String queueKey;

  public RedisDelayingQueue(Jedis jedis, String queueKey) {
    this.jedis = jedis;
    this.queueKey = queueKey;
  }

  public void delay(T msg) {
    TaskItem<T> task = new TaskItem<T>();
    task.id = UUID.randomUUID().toString(); // åˆ†é…å”¯ä¸€çš„ uuid
    task.msg = msg;
    String s = JSON.toJSONString(task); // fastjson åºåˆ—åŒ–
    jedis.zadd(queueKey, System.currentTimeMillis() + 5000, s); // å¡å…¥å»¶æ—¶é˜Ÿåˆ— ,5s åå†è¯•
  }

  public void loop() {
   while (!Thread.interrupted()) {
      // åªå–ä¸€æ¡
      Set<String> values = jedis.zrangeByScore(queueKey, 0, System.currentTimeMillis(), 0, 1);
      if (values.isEmpty()) {
        try {
          Thread.sleep(500); // æ­‡ä¼šç»§ç»­
        } catch (InterruptedException e) {
          break;
        }
        continue;
      }
      String s = values.iterator().next();
      if (jedis.zrem(queueKey, s) > 0) { // æŠ¢åˆ°äº†
        TaskItem<T> task = JSON.parseObject(s, TaskType); // fastjson ååºåˆ—åŒ–
        this.handleMsg(task.msg);
      }
    }
  }

  public void handleMsg(T msg) {
    System.out.println(msg);
  }

  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    RedisDelayingQueue<String> queue = new RedisDelayingQueue<>(jedis, "q-demo");
    Thread producer = new Thread() {

      public void run() {
        for (int i = 0; i < 10; i++) {
          queue.delay("codehole" + i);
        }
      }

    };
    Thread consumer = new Thread() {

      public void run() {
        queue.loop();
      }

 producer.start();
    consumer.start();
    try {
      producer.join();
      Thread.sleep(6000);
      consumer.interrupt();
      consumer.join();
    } catch (InterruptedException e) {
    }
  }
}
```

## è¿›ä¸€æ­¥ä¼˜åŒ–

ä¸Šé¢çš„ç®—æ³•ä¸­åŒä¸€ä¸ªä»»åŠ¡å¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹å–åˆ°ä¹‹åå†ä½¿ç”¨zremè¿›è¡Œäº‰æŠ¢ï¼Œé‚£äº›æ²¡æŠ¢åˆ°çš„è¿›ç¨‹éƒ½æ˜¯ç™½å–äº†ä¸€æ¬¡ä»»åŠ¡ï¼Œè¿™æ˜¯æµªè´¹ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨lua scriptingæ¥ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªé€»è¾‘ï¼Œå°†zrangebyscoreå’Œzremä¸€åŒæŒªåˆ°æœåŠ¡å™¨ç«¯è¿›è¡ŒåŸå­åŒ–æ“ä½œï¼Œè¿™æ ·å¤šä¸ªè¿›ç¨‹ä¹‹é—´äº‰æŠ¢ä»»åŠ¡æ—¶å°±ä¸ä¼šå‡ºç°è¿™ç§æµªè´¹äº†ã€‚

# äº”ã€åº”ç”¨3 ä½å›¾

åœ¨æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€äº› bool å‹æ•°æ®éœ€è¦å­˜å–ï¼Œæ¯”å¦‚ç”¨æˆ·ä¸€å¹´çš„ç­¾åˆ°è®°å½•ï¼Œç­¾äº†æ˜¯ 1ï¼Œæ²¡ç­¾æ˜¯ 0ï¼Œè¦è®°å½• 365 å¤©ã€‚å¦‚æœä½¿ç”¨æ™®é€šçš„ key/valueï¼Œæ¯ä¸ªç”¨æˆ·è¦è®°å½• 365 ä¸ªï¼Œå½“ç”¨æˆ·ä¸Šäº¿çš„æ—¶å€™ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis æä¾›äº†ä½å›¾æ•°æ®ç»“æ„ï¼Œè¿™æ ·æ¯å¤©çš„ç­¾åˆ°è®°å½•åªå æ®ä¸€ä¸ªä½ï¼Œ365 å¤©å°±æ˜¯ 365 ä¸ªä½ï¼Œ46 ä¸ªå­—èŠ‚ (ä¸€ä¸ªç¨é•¿ä¸€ç‚¹çš„å­—ç¬¦ä¸²) å°±å¯ä»¥å®Œå…¨å®¹çº³ä¸‹ï¼Œè¿™å°±å¤§å¤§èŠ‚çº¦äº†å­˜å‚¨ç©ºé—´ã€‚

![](1645926f4520d0ce)

ä½å›¾ä¸æ˜¯ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå®ƒçš„å†…å®¹å…¶å®å°±æ˜¯æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯ byte æ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šçš„ get/set ç›´æ¥è·å–å’Œè®¾ç½®æ•´ä¸ªä½å›¾çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä½å›¾æ“ä½œ getbit/setbit ç­‰å°† byte æ•°ç»„çœ‹æˆã€Œä½æ•°ç»„ã€æ¥å¤„ç†ã€‚

ä»¥è€é’±çš„ç»éªŒï¼Œåœ¨é¢è¯•ä¸­æœ‰ Redis ä½å›¾ä½¿ç”¨ç»éªŒçš„åŒå­¦å¾ˆå°‘ï¼Œå¦‚æœä½ å¯¹ Redis çš„ä½å›¾æœ‰æ‰€äº†è§£ï¼Œå®ƒå°†ä¼šæ˜¯ä½ çš„é¢è¯•åŠ åˆ†é¡¹ã€‚

## åŸºæœ¬ä½¿ç”¨

Redis çš„ä½æ•°ç»„æ˜¯è‡ªåŠ¨æ‰©å±•ï¼Œå¦‚æœè®¾ç½®äº†æŸä¸ªåç§»ä½ç½®è¶…å‡ºäº†ç°æœ‰çš„å†…å®¹èŒƒå›´ï¼Œå°±ä¼šè‡ªåŠ¨å°†ä½æ•°ç»„è¿›è¡Œé›¶æ‰©å……ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ä½æ“ä½œå°†å­—ç¬¦ä¸²è®¾ç½®ä¸º hello (ä¸æ˜¯ç›´æ¥ä½¿ç”¨ set æŒ‡ä»¤)ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å¾—åˆ° hello çš„ ASCII ç ï¼Œç”¨ Python å‘½ä»¤è¡Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¾—åˆ°æ¯ä¸ªå­—ç¬¦çš„ ASCII ç çš„äºŒè¿›åˆ¶å€¼ã€‚

```python
>>> bin(ord('h'))
'0b1101000'   # é«˜ä½ -> ä½ä½
>>> bin(ord('e'))
'0b1100101'
>>> bin(ord('l'))
'0b1101100'
>>> bin(ord('l'))
'0b1101100'
>>> bin(ord('o'))
'0b1101111'
```

![](16459860644097de)

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ redis-cli è®¾ç½®ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä½æ•°ç»„çš„å‰ 8 ä½ï¼Œæˆ‘ä»¬åªéœ€è¦è®¾ç½®å€¼ä¸º 1 çš„ä½ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œh å­—ç¬¦åªæœ‰ 1/2/4 ä½éœ€è¦è®¾ç½®ï¼Œe å­—ç¬¦åªæœ‰ 9/10/13/15 ä½éœ€è¦è®¾ç½®ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ä½æ•°ç»„çš„é¡ºåºå’Œå­—ç¬¦çš„ä½é¡ºåºæ˜¯ç›¸åçš„ã€‚

```assembly
127.0.0.1:6379> setbit s 1 1
(integer) 0
127.0.0.1:6379> setbit s 2 1
(integer) 0
127.0.0.1:6379> setbit s 4 1
(integer) 0
127.0.0.1:6379> setbit s 9 1
(integer) 0
127.0.0.1:6379> setbit s 10 1
(integer) 0
127.0.0.1:6379> setbit s 13 1
(integer) 0
127.0.0.1:6379> setbit s 15 1
(integer) 0
127.0.0.1:6379> get s
"he"
```

ä¸Šé¢è¿™ä¸ªä¾‹å­å¯ä»¥ç†è§£ä¸ºã€Œé›¶å­˜æ•´å–ã€ï¼ŒåŒæ ·æˆ‘ä»¬è¿˜ä¹Ÿå¯ä»¥ã€Œé›¶å­˜é›¶å–ã€ï¼Œã€Œæ•´å­˜é›¶å–ã€ã€‚ã€Œé›¶å­˜ã€å°±æ˜¯ä½¿ç”¨ setbit å¯¹ä½å€¼è¿›è¡Œé€ä¸ªè®¾ç½®ï¼Œã€Œæ•´å­˜ã€å°±æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ä¸€æ¬¡æ€§å¡«å……æ‰€æœ‰ä½æ•°ç»„ï¼Œè¦†ç›–æ‰æ—§å€¼ã€‚

**é›¶å­˜é›¶å–**

```assembly
127.0.0.1:6379> setbit w 1 1
(integer) 0
127.0.0.1:6379> setbit w 2 1
(integer) 0
127.0.0.1:6379> setbit w 4 1
(integer) 0
127.0.0.1:6379> getbit w 1  # è·å–æŸä¸ªå…·ä½“ä½ç½®çš„å€¼ 0/1
(integer) 1
127.0.0.1:6379> getbit w 2
(integer) 1
127.0.0.1:6379> getbit w 4
(integer) 1
127.0.0.1:6379> getbit w 5
(integer) 0
```

**æ•´å­˜é›¶å–**

```assembly
127.0.0.1:6379> set w h  # æ•´å­˜
(integer) 0
127.0.0.1:6379> getbit w 1
(integer) 1
127.0.0.1:6379> getbit w 2
(integer) 1
127.0.0.1:6379> getbit w 4
(integer) 1
127.0.0.1:6379> getbit w 5
(integer) 0
```

å¦‚æœå¯¹åº”ä½çš„å­—èŠ‚æ˜¯ä¸å¯æ‰“å°å­—ç¬¦ï¼Œredis-cli ä¼šæ˜¾ç¤ºè¯¥å­—ç¬¦çš„ 16 è¿›åˆ¶å½¢å¼ã€‚

```assembly
127.0.0.1:6379> setbit x 0 1
(integer) 0
127.0.0.1:6379> setbit x 1 1
(integer) 0
127.0.0.1:6379> get x
"\xc0"
```

## ç»Ÿè®¡å’ŒæŸ¥æ‰¾

Redis æä¾›äº†ä½å›¾ç»Ÿè®¡æŒ‡ä»¤ bitcount å’Œä½å›¾æŸ¥æ‰¾æŒ‡ä»¤ bitposï¼Œbitcount ç”¨æ¥ç»Ÿè®¡æŒ‡å®šä½ç½®èŒƒå›´å†… 1 çš„ä¸ªæ•°ï¼Œbitpos ç”¨æ¥æŸ¥æ‰¾æŒ‡å®šèŒƒå›´å†…å‡ºç°çš„ç¬¬ä¸€ä¸ª 0 æˆ– 1ã€‚

æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ bitcount ç»Ÿè®¡ç”¨æˆ·ä¸€å…±ç­¾åˆ°äº†å¤šå°‘å¤©ï¼Œé€šè¿‡ bitpos æŒ‡ä»¤æŸ¥æ‰¾ç”¨æˆ·ä»å“ªä¸€å¤©å¼€å§‹ç¬¬ä¸€æ¬¡ç­¾åˆ°ã€‚å¦‚æœæŒ‡å®šäº†èŒƒå›´å‚æ•°[start, end]ï¼Œå°±å¯ä»¥ç»Ÿè®¡åœ¨æŸä¸ªæ—¶é—´èŒƒå›´å†…ç”¨æˆ·ç­¾åˆ°äº†å¤šå°‘å¤©ï¼Œç”¨æˆ·è‡ªæŸå¤©ä»¥åçš„å“ªå¤©å¼€å§‹ç­¾åˆ°ã€‚

é—æ†¾çš„æ˜¯ï¼Œ start å’Œ end å‚æ•°æ˜¯å­—èŠ‚ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡å®šçš„ä½èŒƒå›´å¿…é¡»æ˜¯ 8 çš„å€æ•°ï¼Œè€Œä¸èƒ½ä»»æ„æŒ‡å®šã€‚è¿™å¾ˆå¥‡æ€ªï¼Œæˆ‘è¡¨ç¤ºä¸æ˜¯å¾ˆèƒ½ç†è§£ Antirez ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ã€‚å› ä¸ºè¿™ä¸ªè®¾è®¡ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è®¡ç®—æŸä¸ªæœˆå†…ç”¨æˆ·ç­¾åˆ°äº†å¤šå°‘å¤©ï¼Œè€Œå¿…é¡»è¦å°†è¿™ä¸ªæœˆæ‰€è¦†ç›–çš„å­—èŠ‚å†…å®¹å…¨éƒ¨å–å‡ºæ¥ (getrange å¯ä»¥å–å‡ºå­—ç¬¦ä¸²çš„å­ä¸²) ç„¶ååœ¨å†…å­˜é‡Œè¿›è¡Œç»Ÿè®¡ï¼Œè¿™ä¸ªéå¸¸ç¹çã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•è¯•ç”¨ä¸€ä¸‹ bitcount æŒ‡ä»¤å’Œ bitpos æŒ‡ä»¤:

```assembly
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitcount w
(integer) 21
127.0.0.1:6379> bitcount w 0 0  # ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸­ 1 çš„ä½æ•°
(integer) 3
127.0.0.1:6379> bitcount w 0 1  # å‰ä¸¤ä¸ªå­—ç¬¦ä¸­ 1 çš„ä½æ•°
(integer) 7
127.0.0.1:6379> bitpos w 0  # ç¬¬ä¸€ä¸ª 0 ä½
(integer) 0
127.0.0.1:6379> bitpos w 1  # ç¬¬ä¸€ä¸ª 1 ä½
(integer) 1
127.0.0.1:6379> bitpos w 1 1 1  # ä»ç¬¬äºŒä¸ªå­—ç¬¦ç®—èµ·ï¼Œç¬¬ä¸€ä¸ª 1 ä½
(integer) 9
127.0.0.1:6379> bitpos w 1 2 2  # ä»ç¬¬ä¸‰ä¸ªå­—ç¬¦ç®—èµ·ï¼Œç¬¬ä¸€ä¸ª 1 ä½
(integer) 17
```

## é­”æœ¯æŒ‡ä»¤ bitfield

å‰æ–‡æˆ‘ä»¬è®¾ç½® (setbit) å’Œè·å– (getbit) æŒ‡å®šä½çš„å€¼éƒ½æ˜¯å•ä¸ªä½çš„ï¼Œå¦‚æœè¦ä¸€æ¬¡æ“ä½œå¤šä¸ªä½ï¼Œå°±å¿…é¡»ä½¿ç”¨ç®¡é“æ¥å¤„ç†ã€‚

ä¸è¿‡ Redis çš„ 3.2 ç‰ˆæœ¬ä»¥åæ–°å¢äº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æŒ‡ä»¤ï¼Œæœ‰äº†è¿™æ¡æŒ‡ä»¤ï¼Œä¸ç”¨ç®¡é“ä¹Ÿå¯ä»¥ä¸€æ¬¡è¿›è¡Œå¤šä¸ªä½çš„æ“ä½œã€‚

bitfield æœ‰ä¸‰ä¸ªå­æŒ‡ä»¤ï¼Œåˆ†åˆ«æ˜¯ get/set/incrbyï¼Œå®ƒä»¬éƒ½å¯ä»¥å¯¹æŒ‡å®šä½ç‰‡æ®µè¿›è¡Œè¯»å†™ï¼Œä½†æ˜¯æœ€å¤šåªèƒ½å¤„ç† 64 ä¸ªè¿ç»­çš„ä½ï¼Œå¦‚æœè¶…è¿‡ 64 ä½ï¼Œå°±å¾—ä½¿ç”¨å¤šä¸ªå­æŒ‡ä»¤ï¼Œbitfield å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå­æŒ‡ä»¤ã€‚

![](818FF6FC-ED55-4CA7-BA7A-A5AD6A3EA54C.png)

æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹ç…§ç€ä¸Šé¢çš„å›¾çœ‹ä¸ªç®€å•çš„ä¾‹å­:

```assembly
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitfield w get u4 0  # ä»ç¬¬ä¸€ä¸ªä½å¼€å§‹å– 4 ä¸ªä½ï¼Œç»“æœæ˜¯æ— ç¬¦å·æ•° (u)
(integer) 6
127.0.0.1:6379> bitfield w get u3 2  # ä»ç¬¬ä¸‰ä¸ªä½å¼€å§‹å– 3 ä¸ªä½ï¼Œç»“æœæ˜¯æ— ç¬¦å·æ•° (u)
(integer) 5
127.0.0.1:6379> bitfield w get i4 0  # ä»ç¬¬ä¸€ä¸ªä½å¼€å§‹å– 4 ä¸ªä½ï¼Œç»“æœæ˜¯æœ‰ç¬¦å·æ•° (i)
1) (integer) 6
127.0.0.1:6379> bitfield w get i3 2  # ä»ç¬¬ä¸‰ä¸ªä½å¼€å§‹å– 3 ä¸ªä½ï¼Œç»“æœæ˜¯æœ‰ç¬¦å·æ•° (i)
1) (integer) -3
```

æ‰€è°“æœ‰ç¬¦å·æ•°æ˜¯æŒ‡è·å–çš„ä½æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªä½æ˜¯ç¬¦å·ä½ï¼Œå‰©ä¸‹çš„æ‰æ˜¯å€¼ã€‚å¦‚æœç¬¬ä¸€ä½æ˜¯ 1ï¼Œé‚£å°±æ˜¯è´Ÿæ•°ã€‚æ— ç¬¦å·æ•°è¡¨ç¤ºéè´Ÿæ•°ï¼Œæ²¡æœ‰ç¬¦å·ä½ï¼Œè·å–çš„ä½æ•°ç»„å…¨éƒ¨éƒ½æ˜¯å€¼ã€‚æœ‰ç¬¦å·æ•°æœ€å¤šå¯ä»¥è·å– 64 ä½ï¼Œæ— ç¬¦å·æ•°åªèƒ½è·å– 63 ä½ (å› ä¸º Redis åè®®ä¸­çš„ integer æ˜¯æœ‰ç¬¦å·æ•°ï¼Œæœ€å¤§ 64 ä½ï¼Œä¸èƒ½ä¼ é€’ 64 ä½æ— ç¬¦å·å€¼)ã€‚å¦‚æœè¶…å‡ºä½æ•°é™åˆ¶ï¼ŒRedis å°±ä¼šå‘Šè¯‰ä½ å‚æ•°é”™è¯¯ã€‚

```assembly
127.0.0.1:6379> bitfield w get u4 0 get u3 2 get i4 0 get i3 2
1) (integer) 6
2) (integer) 5
3) (integer) 6
4) (integer) -3
```

wowï¼Œå¾ˆé­”æ³•æœ‰æ²¡æœ‰ï¼

ç„¶åæˆ‘ä»¬ä½¿ç”¨ set å­æŒ‡ä»¤å°†ç¬¬äºŒä¸ªå­—ç¬¦ e æ”¹æˆ aï¼Œa çš„ ASCII ç æ˜¯ 97ã€‚

```assembly
127.0.0.1:6379> bitfield w set u8 8 97  # ä»ç¬¬ 8 ä¸ªä½å¼€å§‹ï¼Œå°†æ¥ä¸‹æ¥çš„ 8 ä¸ªä½ç”¨æ— ç¬¦å·æ•° 97 æ›¿æ¢
1) (integer) 101
127.0.0.1:6379> get w
"hallo"
```

å†çœ‹ç¬¬ä¸‰ä¸ªå­æŒ‡ä»¤ incrbyï¼Œå®ƒç”¨æ¥å¯¹æŒ‡å®šèŒƒå›´çš„ä½è¿›è¡Œè‡ªå¢æ“ä½œã€‚æ—¢ç„¶æåˆ°è‡ªå¢ï¼Œå°±æœ‰å¯èƒ½å‡ºç°æº¢å‡ºã€‚å¦‚æœå¢åŠ äº†æ­£æ•°ï¼Œä¼šå‡ºç°ä¸Šæº¢ï¼Œå¦‚æœå¢åŠ çš„æ˜¯è´Ÿæ•°ï¼Œå°±ä¼šå‡ºç°ä¸‹æº¢å‡ºã€‚Redis é»˜è®¤çš„å¤„ç†æ˜¯æŠ˜è¿”ã€‚å¦‚æœå‡ºç°äº†æº¢å‡ºï¼Œå°±å°†æº¢å‡ºçš„ç¬¦å·ä½ä¸¢æ‰ã€‚å¦‚æœæ˜¯ 8 ä½æ— ç¬¦å·æ•° 255ï¼ŒåŠ  1 åå°±ä¼šæº¢å‡ºï¼Œä¼šå…¨éƒ¨å˜é›¶ã€‚å¦‚æœæ˜¯ 8 ä½æœ‰ç¬¦å·æ•° 127ï¼ŒåŠ  1 åå°±ä¼šæº¢å‡ºå˜æˆ -128ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å®è·µä¸€ä¸‹è¿™ä¸ªå­æŒ‡ä»¤ incrby :

```assembly
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitfield w incrby u4 2 1  # ä»ç¬¬ä¸‰ä¸ªä½å¼€å§‹ï¼Œå¯¹æ¥ä¸‹æ¥çš„ 4 ä½æ— ç¬¦å·æ•° +1
1) (integer) 11
127.0.0.1:6379> bitfield w incrby u4 2 1
1) (integer) 12
127.0.0.1:6379> bitfield w incrby u4 2 1
1) (integer) 13
127.0.0.1:6379> bitfield w incrby u4 2 1
1) (integer) 14
127.0.0.1:6379> bitfield w incrby u4 2 1
1) (integer) 15
127.0.0.1:6379> bitfield w incrby u4 2 1  # æº¢å‡ºæŠ˜è¿”äº†
1) (integer) 0
```

bitfield æŒ‡ä»¤æä¾›äº†æº¢å‡ºç­–ç•¥å­æŒ‡ä»¤ overflowï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æº¢å‡ºè¡Œä¸ºï¼Œé»˜è®¤æ˜¯æŠ˜è¿” (wrap)ï¼Œè¿˜å¯ä»¥é€‰æ‹©å¤±è´¥ (fail) æŠ¥é”™ä¸æ‰§è¡Œï¼Œä»¥åŠé¥±å’Œæˆªæ–­ (sat)ï¼Œè¶…è¿‡äº†èŒƒå›´å°±åœç•™åœ¨æœ€å¤§æœ€å°å€¼ã€‚overflow æŒ‡ä»¤åªå½±å“æ¥ä¸‹æ¥çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œè¿™æ¡æŒ‡ä»¤æ‰§è¡Œå®Œåæº¢å‡ºç­–ç•¥ä¼šå˜æˆé»˜è®¤å€¼æŠ˜è¿” (wrap)ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«è¯•è¯•è¿™ä¸¤ä¸ªç­–ç•¥çš„è¡Œä¸º

**é¥±å’Œæˆªæ–­ SAT**

```assembly
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 11
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 12
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 13
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 14
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 15
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1  # ä¿æŒæœ€å¤§å€¼
1) (integer) 15
```

# å…­ã€åº”ç”¨4 HyperLogLog

åœ¨å¼€å§‹è¿™ä¸€èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸ªå¸¸è§çš„ä¸šåŠ¡é—®é¢˜ï¼šå¦‚æœä½ è´Ÿè´£å¼€å‘ç»´æŠ¤ä¸€ä¸ªå¤§å‹çš„ç½‘ç«™ï¼Œæœ‰ä¸€å¤©è€æ¿æ‰¾äº§å“ç»ç†è¦ç½‘ç«™æ¯ä¸ªç½‘é¡µæ¯å¤©çš„ UV æ•°æ®ï¼Œç„¶åè®©ä½ æ¥å¼€å‘è¿™ä¸ªç»Ÿè®¡æ¨¡å—ï¼Œä½ ä¼šå¦‚ä½•å®ç°ï¼Ÿ

![](1648f065e38200cb)



å¦‚æœç»Ÿè®¡ PV é‚£éå¸¸å¥½åŠï¼Œç»™æ¯ä¸ªç½‘é¡µä¸€ä¸ªç‹¬ç«‹çš„ Redis è®¡æ•°å™¨å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªè®¡æ•°å™¨çš„ key åç¼€åŠ ä¸Šå½“å¤©çš„æ—¥æœŸã€‚è¿™æ ·æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œincrby ä¸€æ¬¡ï¼Œæœ€ç»ˆå°±å¯ä»¥ç»Ÿè®¡å‡ºæ‰€æœ‰çš„ PV æ•°æ®ã€‚

ä½†æ˜¯ UV ä¸ä¸€æ ·ï¼Œå®ƒè¦å»é‡ï¼ŒåŒä¸€ä¸ªç”¨æˆ·ä¸€å¤©ä¹‹å†…çš„å¤šæ¬¡è®¿é—®è¯·æ±‚åªèƒ½è®¡æ•°ä¸€æ¬¡ã€‚è¿™å°±è¦æ±‚æ¯ä¸€ä¸ªç½‘é¡µè¯·æ±‚éƒ½éœ€è¦å¸¦ä¸Šç”¨æˆ·çš„ IDï¼Œæ— è®ºæ˜¯ç™»é™†ç”¨æˆ·è¿˜æ˜¯æœªç™»é™†ç”¨æˆ·éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€ ID æ¥æ ‡è¯†ã€‚

ä½ ä¹Ÿè®¸å·²ç»æƒ³åˆ°äº†ä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªé¡µé¢ä¸€ä¸ªç‹¬ç«‹çš„ set é›†åˆæ¥å­˜å‚¨æ‰€æœ‰å½“å¤©è®¿é—®è¿‡æ­¤é¡µé¢çš„ç”¨æˆ· IDã€‚å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ sadd å°†ç”¨æˆ· ID å¡è¿›å»å°±å¯ä»¥äº†ã€‚é€šè¿‡ scard å¯ä»¥å–å‡ºè¿™ä¸ªé›†åˆçš„å¤§å°ï¼Œè¿™ä¸ªæ•°å­—å°±æ˜¯è¿™ä¸ªé¡µé¢çš„ UV æ•°æ®ã€‚æ²¡é”™ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ¡ˆã€‚

ä½†æ˜¯ï¼Œå¦‚æœä½ çš„é¡µé¢è®¿é—®é‡éå¸¸å¤§ï¼Œæ¯”å¦‚ä¸€ä¸ªçˆ†æ¬¾é¡µé¢å‡ åƒä¸‡çš„ UVï¼Œä½ éœ€è¦ä¸€ä¸ªå¾ˆå¤§çš„ set é›†åˆæ¥ç»Ÿè®¡ï¼Œè¿™å°±éå¸¸æµªè´¹ç©ºé—´ã€‚å¦‚æœè¿™æ ·çš„é¡µé¢å¾ˆå¤šï¼Œé‚£æ‰€éœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚ä¸ºè¿™æ ·ä¸€ä¸ªå»é‡åŠŸèƒ½å°±è€—è´¹è¿™æ ·å¤šçš„å­˜å‚¨ç©ºé—´ï¼Œå€¼å¾—ä¹ˆï¼Ÿå…¶å®è€æ¿éœ€è¦çš„æ•°æ®åˆä¸éœ€è¦å¤ªç²¾ç¡®ï¼Œ105w å’Œ 106w è¿™ä¸¤ä¸ªæ•°å­—å¯¹äºè€æ¿ä»¬æ¥è¯´å¹¶æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼ŒSoï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ

è¿™å°±æ˜¯æœ¬èŠ‚è¦å¼•å…¥çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼ŒRedis æä¾›äº† HyperLogLog æ•°æ®ç»“æ„å°±æ˜¯ç”¨æ¥è§£å†³è¿™ç§ç»Ÿè®¡é—®é¢˜çš„ã€‚

HyperLogLog æä¾›ä¸ç²¾ç¡®çš„å»é‡è®¡æ•°æ–¹æ¡ˆï¼Œè™½ç„¶ä¸ç²¾ç¡®ä½†æ˜¯ä¹Ÿä¸æ˜¯éå¸¸ä¸ç²¾ç¡®ï¼Œæ ‡å‡†è¯¯å·®æ˜¯ 0.81%ï¼Œè¿™æ ·çš„ç²¾ç¡®åº¦å·²ç»å¯ä»¥æ»¡è¶³ä¸Šé¢çš„ UV ç»Ÿè®¡éœ€æ±‚äº†ã€‚

HyperLogLog æ•°æ®ç»“æ„æ˜¯ Redis çš„é«˜çº§æ•°æ®ç»“æ„ï¼Œå®ƒéå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯ä»¤äººæ„Ÿåˆ°æ„å¤–çš„æ˜¯ï¼Œä½¿ç”¨è¿‡å®ƒçš„äººéå¸¸å°‘ã€‚

## ä½¿ç”¨æ–¹æ³•

HyperLogLog æä¾›äº†ä¸¤ä¸ªæŒ‡ä»¤ pfadd å’Œ pfcountï¼Œæ ¹æ®å­—é¢æ„ä¹‰å¾ˆå¥½ç†è§£ï¼Œä¸€ä¸ªæ˜¯å¢åŠ è®¡æ•°ï¼Œä¸€ä¸ªæ˜¯è·å–è®¡æ•°ã€‚pfadd ç”¨æ³•å’Œ set é›†åˆçš„ sadd æ˜¯ä¸€æ ·çš„ï¼Œæ¥ä¸€ä¸ªç”¨æˆ· IDï¼Œå°±å°†ç”¨æˆ· ID å¡è¿›å»å°±æ˜¯ã€‚pfcount å’Œ scard ç”¨æ³•æ˜¯ä¸€æ ·çš„ï¼Œç›´æ¥è·å–è®¡æ•°å€¼ã€‚

```assembly
127.0.0.1:6379> pfadd codehole user1
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 1
127.0.0.1:6379> pfadd codehole user2
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 2
127.0.0.1:6379> pfadd codehole user3
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 3
127.0.0.1:6379> pfadd codehole user4
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 4
127.0.0.1:6379> pfadd codehole user5
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 5
127.0.0.1:6379> pfadd codehole user6
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 6
127.0.0.1:6379> pfadd codehole user7 user8 user9 user10
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 10
```

ç®€å•è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°è¿˜è›®ç²¾ç¡®çš„ï¼Œä¸€ä¸ªæ²¡å¤šä¹Ÿä¸€ä¸ªæ²¡å°‘ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨è„šæœ¬ï¼Œå¾€é‡Œé¢çŒæ›´å¤šçš„æ•°æ®ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦è¿˜å¯ä»¥ç»§ç»­ç²¾ç¡®ä¸‹å»ï¼Œå¦‚æœä¸èƒ½ç²¾ç¡®ï¼Œå·®è·æœ‰å¤šå¤§ã€‚äººç”Ÿè‹¦çŸ­ï¼Œæˆ‘ç”¨ Pythonï¼Python è„šæœ¬èµ°èµ·æ¥ï¼ğŸ˜„

```python
# coding: utf-8

import redis

client = redis.StrictRedis()
for i in range(1000):
    client.pfadd("codehole", "user%d" % i)
    total = client.pfcount("codehole")
    if total != i+1:
        print total, i+1
        break
```

å½“ç„¶ Java ä¹Ÿä¸é”™ï¼Œå¤§åŒå°å¼‚ï¼Œä¸‹é¢æ˜¯ Java ç‰ˆæœ¬ï¼š

```java
ublic class PfTest {
  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    for (int i = 0; i < 1000; i++) {
      jedis.pfadd("codehole", "user" + i);
      long total = jedis.pfcount("codehole");
      if (total != i + 1) {
        System.out.printf("%d %d\n", total, i + 1);
        break;
      }
    }
    jedis.close();
  }
}
```

å½“æˆ‘ä»¬åŠ å…¥ç¬¬ 100 ä¸ªå…ƒç´ æ—¶ï¼Œç»“æœå¼€å§‹å‡ºç°äº†ä¸ä¸€è‡´ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ•°æ®å¢åŠ åˆ° 10w ä¸ªï¼Œçœ‹çœ‹æ€»é‡å·®è·æœ‰å¤šå¤§ã€‚

```python
# coding: utf-8

import redis

client = redis.StrictRedis()
for i in range(100000):
    client.pfadd("codehole", "user%d" % i)
print 100000, client.pfcount("codehole")
```

Java ç‰ˆï¼š

```java
public class JedisTest {
  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    for (int i = 0; i < 100000; i++) {
      jedis.pfadd("codehole", "user" + i);
    }
    long total = jedis.pfcount("codehole");
    System.out.printf("%d %d\n", 100000, total);
    jedis.close();
  }
}
```

å·®äº† 277 ä¸ªï¼ŒæŒ‰ç™¾åˆ†æ¯”æ˜¯ 0.277%ï¼Œå¯¹äºä¸Šé¢çš„ UV ç»Ÿè®¡éœ€æ±‚æ¥è¯´ï¼Œè¯¯å·®ç‡ä¹Ÿä¸ç®—é«˜ã€‚ç„¶åæˆ‘ä»¬æŠŠä¸Šé¢çš„è„šæœ¬å†è·‘ä¸€è¾¹ï¼Œä¹Ÿå°±ç›¸å½“äºå°†æ•°æ®é‡å¤åŠ å…¥ä¸€è¾¹ï¼ŒæŸ¥çœ‹è¾“å‡ºï¼Œå¯ä»¥å‘ç°ï¼Œpfcount çš„ç»“æœæ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Œè¿˜æ˜¯ 99723ï¼Œè¯´æ˜å®ƒç¡®å®å…·å¤‡å»é‡åŠŸèƒ½ã€‚

## pfadd è¿™ä¸ª pf æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

å®ƒæ˜¯ HyperLogLog è¿™ä¸ªæ•°æ®ç»“æ„çš„å‘æ˜äºº Philippe Flajolet çš„é¦–å­—æ¯ç¼©å†™ï¼Œè€å¸ˆè§‰å¾—ä»–å‘å‹å¾ˆé…·ï¼Œçœ‹èµ·æ¥æ˜¯ä¸ªä½›ç³»æ•™æˆã€‚

## pfmerge é€‚åˆä»€ä¹ˆåœºåˆç”¨ï¼Ÿ

HyperLogLog é™¤äº†ä¸Šé¢çš„ pfadd å’Œ pfcount ä¹‹å¤–ï¼Œè¿˜æä¾›äº†ç¬¬ä¸‰ä¸ªæŒ‡ä»¤ pfmergeï¼Œç”¨äºå°†å¤šä¸ª pf è®¡æ•°å€¼ç´¯åŠ åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–°çš„ pf å€¼ã€‚

æ¯”å¦‚åœ¨ç½‘ç«™ä¸­æˆ‘ä»¬æœ‰ä¸¤ä¸ªå†…å®¹å·®ä¸å¤šçš„é¡µé¢ï¼Œè¿è¥è¯´éœ€è¦è¿™ä¸¤ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œåˆå¹¶ã€‚å…¶ä¸­é¡µé¢çš„ UV è®¿é—®é‡ä¹Ÿéœ€è¦åˆå¹¶ï¼Œé‚£è¿™ä¸ªæ—¶å€™ pfmerge å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚

## æ³¨æ„äº‹é¡¹

HyperLogLog è¿™ä¸ªæ•°æ®ç»“æ„ä¸æ˜¯å…è´¹çš„ï¼Œä¸æ˜¯è¯´ä½¿ç”¨è¿™ä¸ªæ•°æ®ç»“æ„è¦èŠ±é’±ï¼Œå®ƒéœ€è¦å æ®ä¸€å®š 12k çš„å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥å®ƒä¸é€‚åˆç»Ÿè®¡å•ä¸ªç”¨æˆ·ç›¸å…³çš„æ•°æ®ã€‚å¦‚æœä½ çš„ç”¨æˆ·ä¸Šäº¿ï¼Œå¯ä»¥ç®—ç®—ï¼Œè¿™ä¸ªç©ºé—´æˆæœ¬æ˜¯éå¸¸æƒŠäººçš„ã€‚ä½†æ˜¯ç›¸æ¯” set å­˜å‚¨æ–¹æ¡ˆï¼ŒHyperLogLog æ‰€ä½¿ç”¨çš„ç©ºé—´é‚£çœŸæ˜¯å¯ä»¥ä½¿ç”¨åƒæ–¤å¯¹æ¯”å››ä¸¤æ¥å½¢å®¹äº†ã€‚

ä¸è¿‡ä½ ä¹Ÿä¸å¿…è¿‡äºå½“å¿ƒï¼Œå› ä¸º Redis å¯¹ HyperLogLog çš„å­˜å‚¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œåœ¨è®¡æ•°æ¯”è¾ƒå°æ—¶ï¼Œå®ƒçš„å­˜å‚¨ç©ºé—´é‡‡ç”¨ç¨€ç–çŸ©é˜µå­˜å‚¨ï¼Œç©ºé—´å ç”¨å¾ˆå°ï¼Œä»…ä»…åœ¨è®¡æ•°æ…¢æ…¢å˜å¤§ï¼Œç¨€ç–çŸ©é˜µå ç”¨ç©ºé—´æ¸æ¸è¶…è¿‡äº†é˜ˆå€¼æ—¶æ‰ä¼šä¸€æ¬¡æ€§è½¬å˜æˆç¨ å¯†çŸ©é˜µï¼Œæ‰ä¼šå ç”¨ 12k çš„ç©ºé—´ã€‚

## HyperLogLog å®ç°åŸç†

HyperLogLog çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†æ˜¯å®ç°åŸç†æ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœè¯»è€…æ²¡æœ‰ç‰¹åˆ«çš„å…´è¶£ï¼Œä¸‹é¢çš„å†…å®¹æš‚æ—¶å¯ä»¥è·³è¿‡ä¸çœ‹ã€‚

ä¸ºäº†æ–¹ä¾¿ç†è§£ HyperLogLog çš„å†…éƒ¨å®ç°åŸç†ï¼Œæˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾

![](1853DF77-65FE-4FFF-B263-5FC5A70576C3.png)

è¿™å¼ å›¾çš„æ„æ€æ˜¯ï¼Œç»™å®šä¸€ç³»åˆ—çš„éšæœºæ•´æ•°ï¼Œæˆ‘ä»¬è®°å½•ä¸‹ä½ä½è¿ç»­é›¶ä½çš„æœ€å¤§é•¿åº¦ kï¼Œé€šè¿‡è¿™ä¸ª k å€¼å¯ä»¥ä¼°ç®—å‡ºéšæœºæ•°çš„æ•°é‡ã€‚ é¦–å…ˆä¸é—®ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬ç¼–å†™ä»£ç åšä¸€ä¸ªå®éªŒï¼Œè§‚å¯Ÿä¸€ä¸‹éšæœºæ•´æ•°çš„æ•°é‡å’Œ k å€¼çš„å…³ç³»ã€‚

```python
import math
import random

# ç®—ä½ä½é›¶çš„ä¸ªæ•°
def low_zeros(value):
    for i in xrange(1, 32):
        if value >> i << i != value:
            break
    return i - 1


# é€šè¿‡éšæœºæ•°è®°å½•æœ€å¤§çš„ä½ä½é›¶çš„ä¸ªæ•°
class BitKeeper(object):

    def __init__(self):
        self.maxbits = 0

    def random(self):
        value = random.randint(0, 2**32-1)
        bits = low_zeros(value)
        if bits > self.maxbits:
            self.maxbits = bits


class Experiment(object):

    def __init__(self, n):
        self.n = n
        self.keeper = BitKeeper()

    def do(self):
        for i in range(self.n):
            self.keeper.random()

    def debug(self):
        print self.n, '%.2f' % math.log(self.n, 2), self.keeper.maxbits


for i in range(1000, 100000, 100):
    exp = Experiment(i)
    exp.do()
    exp.debug()
```

Java ç‰ˆï¼š

```java
public class PfTest {

  static class BitKeeper {
    private int maxbits;

    public void random() {
      long value = ThreadLocalRandom.current().nextLong(2L << 32);
      int bits = lowZeros(value);
      if (bits > this.maxbits) {
        this.maxbits = bits;
      }
    }

    private int lowZeros(long value) {
      int i = 1;
      for (; i < 32; i++) {
        if (value >> i << i != value) {
          break;
        }
      }
      return i - 1;
    }
  }

  static class Experiment {
    private int n;
    private BitKeeper keeper;

    public Experiment(int n) {
      this.n = n;
      this.keeper = new BitKeeper();
    }

    public void work() {
      for (int i = 0; i < n; i++) {
        this.keeper.random();
      }
    }

    public void debug() {
      System.out.printf("%d %.2f %d\n", this.n, Math.log(this.n) / Math.log(2), this.keeper.maxbits);
    }
  }

  public static void main(String[] args) {
    for (int i = 1000; i < 100000; i += 100) {
      Experiment exp = new Experiment(i);
      exp.work();
      exp.debug();
    }
  }

}
```

é€šè¿‡è¿™å®éªŒå¯ä»¥å‘ç° K å’Œ N çš„å¯¹æ•°ä¹‹é—´å­˜åœ¨æ˜¾è‘—çš„çº¿æ€§ç›¸å…³æ€§ï¼š

```assembly
N=2^K  # çº¦ç­‰äº
```

å¦‚æœ N ä»‹äº 2^K å’Œ 2^(K+1) ä¹‹é—´ï¼Œç”¨è¿™ç§æ–¹å¼ä¼°è®¡çš„å€¼éƒ½ç­‰äº 2^Kï¼Œè¿™æ˜æ˜¾æ˜¯ä¸åˆç†çš„ã€‚è¿™é‡Œå¯ä»¥é‡‡ç”¨å¤šä¸ª BitKeeperï¼Œç„¶åè¿›è¡ŒåŠ æƒä¼°è®¡ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ¯”è¾ƒå‡†ç¡®çš„å€¼ã€‚

```python
import math
import random

def low_zeros(value):
    for i in xrange(1, 32):
        if value >> i << i != value:
            break
    return i - 1


class BitKeeper(object):

    def __init__(self):
        self.maxbits = 0

    def random(self, m):
        bits = low_zeros(m)
        if bits > self.maxbits:
            self.maxbits = bits


class Experiment(object):

    def __init__(self, n, k=1024):
        self.n = n
        self.k = k
        self.keepers = [BitKeeper() for i in range(k)]

    def do(self):
        for i in range(self.n):
            m = random.randint(0, 1<<32-1)
            # ç¡®ä¿åŒä¸€ä¸ªæ•´æ•°è¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ¡¶é‡Œé¢ï¼Œæ‘˜å–é«˜ä½åå–æ¨¡
            keeper = self.keepers[((m & 0xfff0000) >> 16) % len(self.keepers)]
            keeper.random(m)

    def estimate(self):
        sumbits_inverse = 0  # é›¶ä½æ•°å€’æ•°
        for keeper in self.keepers:
            sumbits_inverse += 1.0/float(keeper.maxbits)
        avgbits = float(self.k)/sumbits_inverse  # å¹³å‡é›¶ä½æ•°
        return 2**avgbits * self.k  # æ ¹æ®æ¡¶çš„æ•°é‡å¯¹ä¼°è®¡å€¼è¿›è¡Œæ”¾å¤§


for i in range(100000, 1000000, 100000):
    exp = Experiment(i)
    exp.do()
    est = exp.estimate()
    print i, '%.2f' % est, '%.2f' % (abs(est-i) / i)
```

ä¸‹é¢æ˜¯ Java ç‰ˆï¼š

```java
public class PfTest {

  static class BitKeeper {
    private int maxbits;

    public void random(long value) {
      int bits = lowZeros(value);
      if (bits > this.maxbits) {
        this.maxbits = bits;
      }
    }

    private int lowZeros(long value) {
      int i = 1;
      for (; i < 32; i++) {
        if (value >> i << i != value) {
          break;
        }
      }
      return i - 1;
    }
  }

  static class Experiment {
    private int n;
    private int k;
    private BitKeeper[] keepers;

    public Experiment(int n) {
      this(n, 1024);
    }

    public Experiment(int n, int k) {
      this.n = n;
      this.k = k;
      this.keepers = new BitKeeper[k];
      for (int i = 0; i < k; i++) {
        this.keepers[i] = new BitKeeper();
      }
    }

    public void work() {
      for (int i = 0; i < this.n; i++) {
        long m = ThreadLocalRandom.current().nextLong(1L << 32);
        BitKeeper keeper = keepers[(int) (((m & 0xfff0000) >> 16) % keepers.length)];
        keeper.random(m);
      }
    }

    public double estimate() {
      double sumbitsInverse = 0.0;
      for (BitKeeper keeper : keepers) {
        sumbitsInverse += 1.0 / (float) keeper.maxbits;
      }
      double avgBits = (float) keepers.length / sumbitsInverse;
      return Math.pow(2, avgBits) * this.k;
    }
  }

  public static void main(String[] args) {
    for (int i = 100000; i < 1000000; i += 100000) {
      Experiment exp = new Experiment(i);
      exp.work();
      double est = exp.estimate();
      System.out.printf("%d %.2f %.2f\n", i, est, Math.abs(est - i) / i);
    }
  }

}
```

ä»£ç ä¸­åˆ†äº† 1024 ä¸ªæ¡¶ï¼Œè®¡ç®—å¹³å‡æ•°ä½¿ç”¨äº†è°ƒå’Œå¹³å‡ (å€’æ•°çš„å¹³å‡)ã€‚æ™®é€šçš„å¹³å‡æ³•å¯èƒ½å› ä¸ºä¸ªåˆ«ç¦»ç¾¤å€¼å¯¹å¹³å‡ç»“æœäº§ç”Ÿè¾ƒå¤§çš„å½±å“ï¼Œè°ƒå’Œå¹³å‡å¯ä»¥æœ‰æ•ˆå¹³æ»‘ç¦»ç¾¤å€¼çš„å½±å“ã€‚ 

çœŸå®çš„ HyperLogLog è¦æ¯”ä¸Šé¢çš„ç¤ºä¾‹ä»£ç æ›´åŠ å¤æ‚ä¸€äº›ï¼Œä¹Ÿæ›´åŠ ç²¾ç¡®ä¸€äº›ã€‚ä¸Šé¢çš„è¿™ä¸ªç®—æ³•åœ¨éšæœºæ¬¡æ•°å¾ˆå°‘çš„æƒ…å†µä¸‹ä¼šå‡ºç°é™¤é›¶é”™è¯¯ï¼Œå› ä¸º maxbits=0 æ˜¯ä¸å¯ä»¥æ±‚å€’æ•°çš„ã€‚

![](9F3BDB8F-1EFC-4FD6-9961-1980BF575E87.png)

## pf çš„å†…å­˜å ç”¨ä¸ºä»€ä¹ˆæ˜¯ 12kï¼Ÿ

æˆ‘ä»¬åœ¨ä¸Šé¢çš„ç®—æ³•ä¸­ä½¿ç”¨äº† 1024 ä¸ªæ¡¶è¿›è¡Œç‹¬ç«‹è®¡æ•°ï¼Œä¸è¿‡åœ¨ Redis çš„ HyperLogLog å®ç°ä¸­ç”¨åˆ°çš„æ˜¯ 16384 ä¸ªæ¡¶ï¼Œä¹Ÿå°±æ˜¯ 2^14ï¼Œæ¯ä¸ªæ¡¶çš„ maxbits éœ€è¦ 6 ä¸ª bits æ¥å­˜å‚¨ï¼Œæœ€å¤§å¯ä»¥è¡¨ç¤º maxbits=63ï¼Œäºæ˜¯æ€»å…±å ç”¨å†…å­˜å°±æ˜¯2^14 * 6 / 8 = 12kå­—èŠ‚ã€‚

# ä¸ƒã€åº”ç”¨5 å¸ƒéš†è¿‡æ»¤å™¨

ä¸Šä¸€èŠ‚æˆ‘ä»¬å­¦ä¼šäº†ä½¿ç”¨ HyperLogLog æ•°æ®ç»“æ„æ¥è¿›è¡Œä¼°æ•°ï¼Œå®ƒéå¸¸æœ‰ä»·å€¼ï¼Œå¯ä»¥è§£å†³å¾ˆå¤šç²¾ç¡®åº¦ä¸é«˜çš„ç»Ÿè®¡éœ€æ±‚ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³çŸ¥é“æŸä¸€ä¸ªå€¼æ˜¯ä¸æ˜¯å·²ç»åœ¨ HyperLogLog ç»“æ„é‡Œé¢äº†ï¼Œå®ƒå°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œå®ƒåªæä¾›äº† pfadd å’Œ pfcount æ–¹æ³•ï¼Œæ²¡æœ‰æä¾› pfcontains è¿™ç§æ–¹æ³•ã€‚

è®²ä¸ªä½¿ç”¨åœºæ™¯ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ä½¿ç”¨æ–°é—»å®¢æˆ·ç«¯çœ‹æ–°é—»æ—¶ï¼Œå®ƒä¼šç»™æˆ‘ä»¬ä¸åœåœ°æ¨èæ–°çš„å†…å®¹ï¼Œå®ƒæ¯æ¬¡æ¨èæ—¶è¦å»é‡ï¼Œå»æ‰é‚£äº›å·²ç»çœ‹è¿‡çš„å†…å®¹ã€‚é—®é¢˜æ¥äº†ï¼Œæ–°é—»å®¢æˆ·ç«¯æ¨èç³»ç»Ÿå¦‚ä½•å®ç°æ¨é€å»é‡çš„ï¼Ÿ

ä½ ä¼šæƒ³åˆ°æœåŠ¡å™¨è®°å½•äº†ç”¨æˆ·çœ‹è¿‡çš„æ‰€æœ‰å†å²è®°å½•ï¼Œå½“æ¨èç³»ç»Ÿæ¨èæ–°é—»æ—¶ä¼šä»æ¯ä¸ªç”¨æˆ·çš„å†å²è®°å½•é‡Œè¿›è¡Œç­›é€‰ï¼Œè¿‡æ»¤æ‰é‚£äº›å·²ç»å­˜åœ¨çš„è®°å½•ã€‚é—®é¢˜æ˜¯å½“ç”¨æˆ·é‡å¾ˆå¤§ï¼Œæ¯ä¸ªç”¨æˆ·çœ‹è¿‡çš„æ–°é—»åˆå¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹å¼ï¼Œæ¨èç³»ç»Ÿçš„å»é‡å·¥ä½œåœ¨æ€§èƒ½ä¸Šè·Ÿçš„ä¸Šä¹ˆï¼Ÿ

![](164599f30fae2a7f)

å®é™…ä¸Šï¼Œå¦‚æœå†å²è®°å½•å­˜å‚¨åœ¨å…³ç³»æ•°æ®åº“é‡Œï¼Œå»é‡å°±éœ€è¦é¢‘ç¹åœ°å¯¹æ•°æ®åº“è¿›è¡Œ exists æŸ¥è¯¢ï¼Œå½“ç³»ç»Ÿå¹¶å‘é‡å¾ˆé«˜æ—¶ï¼Œæ•°æ®åº“æ˜¯å¾ˆéš¾æ‰›ä½å‹åŠ›çš„ã€‚

ä½ å¯èƒ½åˆæƒ³åˆ°äº†ç¼“å­˜ï¼Œä½†æ˜¯å¦‚æ­¤å¤šçš„å†å²è®°å½•å…¨éƒ¨ç¼“å­˜èµ·æ¥ï¼Œé‚£å¾—æµªè´¹å¤šå¤§å­˜å‚¨ç©ºé—´å•Šï¼Ÿè€Œä¸”è¿™ä¸ªå­˜å‚¨ç©ºé—´æ˜¯éšç€æ—¶é—´çº¿æ€§å¢é•¿ï¼Œä½ æ’‘å¾—ä½ä¸€ä¸ªæœˆï¼Œä½ èƒ½æ’‘å¾—ä½å‡ å¹´ä¹ˆï¼Ÿä½†æ˜¯ä¸ç¼“å­˜çš„è¯ï¼Œæ€§èƒ½åˆè·Ÿä¸ä¸Šï¼Œè¿™è¯¥æ€ä¹ˆåŠï¼Ÿ

è¿™æ—¶ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ (Bloom Filter) é—ªäº®ç™»åœºäº†ï¼Œå®ƒå°±æ˜¯ä¸“é—¨ç”¨æ¥è§£å†³è¿™ç§å»é‡é—®é¢˜çš„ã€‚å®ƒåœ¨èµ·åˆ°å»é‡çš„åŒæ—¶ï¼Œåœ¨ç©ºé—´ä¸Šè¿˜èƒ½èŠ‚çœ 90% ä»¥ä¸Šï¼Œåªæ˜¯ç¨å¾®æœ‰é‚£ä¹ˆç‚¹ä¸ç²¾ç¡®ï¼Œä¹Ÿå°±æ˜¯æœ‰ä¸€å®šçš„è¯¯åˆ¤æ¦‚ç‡ã€‚

## å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä»€ä¹ˆï¼Ÿ

å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªä¸æ€ä¹ˆç²¾ç¡®çš„ set ç»“æ„ï¼Œå½“ä½ ä½¿ç”¨å®ƒçš„ contains æ–¹æ³•åˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦å­˜åœ¨æ—¶ï¼Œå®ƒå¯èƒ½ä¼šè¯¯åˆ¤ã€‚ä½†æ˜¯å¸ƒéš†è¿‡æ»¤å™¨ä¹Ÿä¸æ˜¯ç‰¹åˆ«ä¸ç²¾ç¡®ï¼Œåªè¦å‚æ•°è®¾ç½®çš„åˆç†ï¼Œå®ƒçš„ç²¾ç¡®åº¦å¯ä»¥æ§åˆ¶çš„ç›¸å¯¹è¶³å¤Ÿç²¾ç¡®ï¼Œåªä¼šæœ‰å°å°çš„è¯¯åˆ¤æ¦‚ç‡ã€‚

å½“å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå€¼å­˜åœ¨æ—¶ï¼Œè¿™ä¸ªå€¼å¯èƒ½ä¸å­˜åœ¨ï¼›å½“å®ƒè¯´ä¸å­˜åœ¨æ—¶ï¼Œé‚£å°±è‚¯å®šä¸å­˜åœ¨ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œå½“å®ƒè¯´ä¸è®¤è¯†ä½ æ—¶ï¼Œè‚¯å®šå°±ä¸è®¤è¯†ï¼›å½“å®ƒè¯´è§è¿‡ä½ æ—¶ï¼Œå¯èƒ½æ ¹æœ¬å°±æ²¡è§è¿‡é¢ï¼Œä¸è¿‡å› ä¸ºä½ çš„è„¸è·Ÿå®ƒè®¤è¯†çš„äººä¸­æŸè„¸æ¯”è¾ƒç›¸ä¼¼ (æŸäº›ç†Ÿè„¸çš„ç³»æ•°ç»„åˆ)ï¼Œæ‰€ä»¥è¯¯åˆ¤ä»¥å‰è§è¿‡ä½ ã€‚

å¥—åœ¨ä¸Šé¢çš„ä½¿ç”¨åœºæ™¯ä¸­ï¼Œå¸ƒéš†è¿‡æ»¤å™¨èƒ½å‡†ç¡®è¿‡æ»¤æ‰é‚£äº›å·²ç»çœ‹è¿‡çš„å†…å®¹ï¼Œé‚£äº›æ²¡æœ‰çœ‹è¿‡çš„æ–°å†…å®¹ï¼Œå®ƒä¹Ÿä¼šè¿‡æ»¤æ‰æå°ä¸€éƒ¨åˆ† (è¯¯åˆ¤)ï¼Œä½†æ˜¯ç»å¤§å¤šæ•°æ–°å†…å®¹å®ƒéƒ½èƒ½å‡†ç¡®è¯†åˆ«ã€‚è¿™æ ·å°±å¯ä»¥å®Œå…¨ä¿è¯æ¨èç»™ç”¨æˆ·çš„å†…å®¹éƒ½æ˜¯æ— é‡å¤çš„ã€‚

## Redis ä¸­çš„å¸ƒéš†è¿‡æ»¤å™¨

Redis å®˜æ–¹æä¾›çš„å¸ƒéš†è¿‡æ»¤å™¨åˆ°äº† Redis 4.0 æä¾›äº†æ’ä»¶åŠŸèƒ½ä¹‹åæ‰æ­£å¼ç™»åœºã€‚å¸ƒéš†è¿‡æ»¤å™¨ä½œä¸ºä¸€ä¸ªæ’ä»¶åŠ è½½åˆ° Redis Server ä¸­ï¼Œç»™ Redis æä¾›äº†å¼ºå¤§çš„å¸ƒéš†å»é‡åŠŸèƒ½ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥ä½“éªŒä¸€ä¸‹ Redis 4.0 çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä¸ºäº†çœå»ç¹çå®‰è£…è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ Docker å§ã€‚

```dockerfile
> docker pull redislabs/rebloom  # æ‹‰å–é•œåƒ
> docker run -p6379:6379 redislabs/rebloom  # è¿è¡Œå®¹å™¨
> redis-cli  # è¿æ¥å®¹å™¨ä¸­çš„ redis æœåŠ¡
```

å¦‚æœä¸Šé¢ä¸‰æ¡æŒ‡ä»¤æ‰§è¡Œæ²¡æœ‰é—®é¢˜ï¼Œä¸‹é¢å°±å¯ä»¥ä½“éªŒå¸ƒéš†è¿‡æ»¤å™¨äº†ã€‚

## å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬ä½¿ç”¨

å¸ƒéš†è¿‡æ»¤å™¨æœ‰äºŒä¸ªåŸºæœ¬æŒ‡ä»¤ï¼Œbf.add æ·»åŠ å…ƒç´ ï¼Œbf.exists æŸ¥è¯¢å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå®ƒçš„ç”¨æ³•å’Œ set é›†åˆçš„ sadd å’Œ sismember å·®ä¸å¤šã€‚æ³¨æ„ bf.add åªèƒ½ä¸€æ¬¡æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæƒ³è¦ä¸€æ¬¡æ·»åŠ å¤šä¸ªï¼Œå°±éœ€è¦ç”¨åˆ° bf.madd æŒ‡ä»¤ã€‚åŒæ ·å¦‚æœéœ€è¦ä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå°±éœ€è¦ç”¨åˆ° bf.mexists æŒ‡ä»¤ã€‚

```redis
127.0.0.1:6379> bf.add codehole user1
(integer) 1
127.0.0.1:6379> bf.add codehole user2
(integer) 1
127.0.0.1:6379> bf.add codehole user3
(integer) 1
127.0.0.1:6379> bf.exists codehole user1
(integer) 1
127.0.0.1:6379> bf.exists codehole user2
(integer) 1
127.0.0.1:6379> bf.exists codehole user3
(integer) 1
127.0.0.1:6379> bf.exists codehole user4
(integer) 0
127.0.0.1:6379> bf.madd codehole user4 user5 user6
1) (integer) 1
2) (integer) 1
3) (integer) 1
127.0.0.1:6379> bf.mexists codehole user4 user5 user6 user7
1) (integer) 1
2) (integer) 1
3) (integer) 1
4) (integer) 0
```

ä¼¼ä¹å¾ˆå‡†ç¡®å•Šï¼Œä¸€ä¸ªéƒ½æ²¡è¯¯åˆ¤ã€‚ä¸‹é¢æˆ‘ä»¬ç”¨ Python è„šæœ¬åŠ å…¥å¾ˆå¤šå…ƒç´ ï¼Œçœ‹çœ‹åŠ åˆ°ç¬¬å‡ ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¼šå‡ºç°è¯¯åˆ¤ã€‚

```python
# coding: utf-8

import redis

client = redis.StrictRedis()

client.delete("codehole")
for i in range(100000):
    client.execute_command("bf.add", "codehole", "user%d" % i)
    ret = client.execute_command("bf.exists", "codehole", "user%d" % i)
    if ret == 0:
        print i
        break
```

Java å®¢æˆ·ç«¯ Jedis-2.x æ²¡æœ‰æä¾›æŒ‡ä»¤æ‰©å±•æœºåˆ¶ï¼Œæ‰€ä»¥ä½ æ— æ³•ç›´æ¥ä½¿ç”¨ Jedis æ¥è®¿é—® Redis Module æä¾›çš„ bf.xxx æŒ‡ä»¤ã€‚RedisLabs æä¾›äº†ä¸€ä¸ªå•ç‹¬çš„åŒ… JReBloomï¼Œä½†æ˜¯å®ƒæ˜¯åŸºäº Jedis-3.0ï¼ŒJedis-3.0 è¿™ä¸ªåŒ…ç›®å‰è¿˜æ²¡æœ‰è¿›å…¥ releaseï¼Œæ²¡æœ‰è¿›å…¥ maven çš„ä¸­å¤®ä»“åº“ï¼Œéœ€è¦åœ¨ Github ä¸Šä¸‹è½½ã€‚åœ¨ä½¿ç”¨ä¸Šå¾ˆä¸æ–¹ä¾¿ï¼Œå¦‚æœæ€•éº»çƒ¦ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ lettuceï¼Œå®ƒæ˜¯å¦ä¸€ä¸ª Redis çš„å®¢æˆ·ç«¯ï¼Œç›¸æ¯” Jedis è€Œè¨€ï¼Œå®ƒå¾ˆæ—©å°±æ”¯æŒäº†æŒ‡ä»¤æ‰©å±•ã€‚

```java
public class BloomTest {

  public static void main(String[] args) {
    Client client = new Client();

    client.delete("codehole");
    for (int i = 0; i < 100000; i++) {
      client.add("codehole", "user" + i);
      boolean ret = client.exists("codehole", "user" + i);
      if (!ret) {
        System.out.println(i);
        break;
      }
    }

    client.close();
  }

}
```

æ‰§è¡Œä¸Šé¢çš„ä»£ç åï¼Œä½ ä¼šå¼ å¤§äº†å˜´å·´å‘ç°å±…ç„¶æ²¡æœ‰è¾“å‡ºï¼Œå¡è¿›å»äº† 100000 ä¸ªå…ƒç´ ï¼Œè¿˜æ˜¯æ²¡æœ‰è¯¯åˆ¤ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿå¦‚æœä½ ä¸æ­»å¿ƒçš„è¯ï¼Œå¯ä»¥å°†æ•°å­—å†åŠ ä¸€ä¸ª 0 è¯•è¯•ï¼Œä½ ä¼šå‘ç°ä¾ç„¶æ²¡æœ‰è¯¯åˆ¤ã€‚
åŸå› å°±åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨å¯¹äºå·²ç»è§è¿‡çš„å…ƒç´ è‚¯å®šä¸ä¼šè¯¯åˆ¤ï¼Œå®ƒåªä¼šè¯¯åˆ¤é‚£äº›æ²¡è§è¿‡çš„å…ƒç´ ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ç¨å¾®æ”¹ä¸€ä¸‹ä¸Šé¢çš„è„šæœ¬ï¼Œä½¿ç”¨ bf.exists å»æŸ¥æ‰¾æ²¡è§è¿‡çš„å…ƒç´ ï¼Œçœ‹çœ‹å®ƒæ˜¯ä¸æ˜¯ä»¥ä¸ºè‡ªå·±è§è¿‡äº†ã€‚

```python
# coding: utf-8

import redis

client = redis.StrictRedis()

client.delete("codehole")
for i in range(100000):
    client.execute_command("bf.add", "codehole", "user%d" % i)
    # æ³¨æ„ i+1ï¼Œè¿™ä¸ªæ˜¯å½“å‰å¸ƒéš†è¿‡æ»¤å™¨æ²¡è§è¿‡çš„
    ret = client.execute_command("bf.exists", "codehole", "user%d" % (i+1))
    if ret == 1:
        print i
        break
```

Java ç‰ˆ:

```java
public class BloomTest {

  public static void main(String[] args) {
    Client client = new Client();

    client.delete("codehole");
    for (int i = 0; i < 100000; i++) {
      client.add("codehole", "user" + i);
      boolean ret = client.exists("codehole", "user" + (i + 1));
      if (ret) {
        System.out.println(i);
        break;
      }
    }

    client.close();
  }

}
```

è¿è¡Œåï¼Œæˆ‘ä»¬çœ‹åˆ°äº†è¾“å‡ºæ˜¯ 214ï¼Œä¹Ÿå°±æ˜¯åˆ°ç¬¬ 214 çš„æ—¶å€™ï¼Œå®ƒå‡ºç°äº†è¯¯åˆ¤ã€‚

é‚£å¦‚ä½•æ¥æµ‹é‡è¯¯åˆ¤ç‡å‘¢ï¼Ÿæˆ‘ä»¬å…ˆéšæœºå‡ºä¸€å †å­—ç¬¦ä¸²ï¼Œç„¶ååˆ‡åˆ†ä¸º 2 ç»„ï¼Œå°†å…¶ä¸­ä¸€ç»„å¡å…¥å¸ƒéš†è¿‡æ»¤å™¨ï¼Œç„¶åå†åˆ¤æ–­å¦å¤–ä¸€ç»„çš„å­—ç¬¦ä¸²å­˜åœ¨ä¸å¦ï¼Œå–è¯¯åˆ¤çš„ä¸ªæ•°å’Œå­—ç¬¦ä¸²æ€»é‡ä¸€åŠçš„ç™¾åˆ†æ¯”ä½œä¸ºè¯¯åˆ¤ç‡ã€‚

```python
# coding: utf-8

import redis
import random

client = redis.StrictRedis()

CHARS = ''.join([chr(ord('a') + i) for i in range(26)])

def random_string(n):
    chars = []
    for i in range(n):
        idx = random.randint(0, len(CHARS) - 1)
        chars.append(CHARS[idx])
    return ''.join(chars)


users = list(set([random_string(64) for i in range(100000)]))
print 'total users', len(users)
users_train = users[:len(users)/2]
users_test = users[len(users)/2:]

client.delete("codehole")
falses = 0

for user in users_train:
    client.execute_command("bf.add", "codehole", user)
print 'all trained'
for user in users_test:
    ret = client.execute_command("bf.exists", "codehole", user)
    if ret == 1:
        falses += 1

print falses, len(users_test)
```

Java ç‰ˆ:

```java
public class BloomTest {

  private String chars;
  {
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i < 26; i++) {
      builder.append((char) ('a' + i));
    }
    chars = builder.toString();
  }

  private String randomString(int n) {
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i < n; i++) {
      int idx = ThreadLocalRandom.current().nextInt(chars.length());
      builder.append(chars.charAt(idx));
    }
    return builder.toString();
  }

  private List<String> randomUsers(int n) {
    List<String> users = new ArrayList<>();
    for (int i = 0; i < 100000; i++) {
      users.add(randomString(64));
    }
    return users;
  }
    public static void main(String[] args) {
    BloomTest bloomer = new BloomTest();
    List<String> users = bloomer.randomUsers(100000);
    List<String> usersTrain = users.subList(0, users.size() / 2);
    List<String> usersTest = users.subList(users.size() / 2, users.size());

    Client client = new Client();
    client.delete("codehole");
    for (String user : usersTrain) {
      client.add("codehole", user);
    }
    int falses = 0;
    for (String user : usersTest) {
      boolean ret = client.exists("codehole", user);
      if (ret) {
        falses++;
      }
    }
    System.out.printf("%d %d\n", falses, usersTest.size());
    client.close();
  }

}
```

å¯ä»¥çœ‹åˆ°è¯¯åˆ¤ç‡å¤§çº¦ 1% å¤šç‚¹ã€‚ä½ ä¹Ÿè®¸ä¼šé—®è¿™ä¸ªè¯¯åˆ¤ç‡è¿˜æ˜¯æœ‰ç‚¹é«˜å•Šï¼Œæœ‰æ²¡æœ‰åŠæ³•é™ä½ä¸€ç‚¹ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ã€‚

æˆ‘ä»¬ä¸Šé¢ä½¿ç”¨çš„å¸ƒéš†è¿‡æ»¤å™¨åªæ˜¯é»˜è®¤å‚æ•°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒåœ¨æˆ‘ä»¬ç¬¬ä¸€æ¬¡ add çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºã€‚Redis å…¶å®è¿˜æä¾›äº†è‡ªå®šä¹‰å‚æ•°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œéœ€è¦æˆ‘ä»¬åœ¨ add ä¹‹å‰ä½¿ç”¨bf.reserveæŒ‡ä»¤æ˜¾å¼åˆ›å»ºã€‚å¦‚æœå¯¹åº”çš„ key å·²ç»å­˜åœ¨ï¼Œbf.reserveä¼šæŠ¥é”™ã€‚bf.reserveæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ key, error_rateå’Œinitial_sizeã€‚é”™è¯¯ç‡è¶Šä½ï¼Œéœ€è¦çš„ç©ºé—´è¶Šå¤§ã€‚initial_sizeå‚æ•°è¡¨ç¤ºé¢„è®¡æ”¾å…¥çš„å…ƒç´ æ•°é‡ï¼Œå½“å®é™…æ•°é‡è¶…å‡ºè¿™ä¸ªæ•°å€¼æ—¶ï¼Œè¯¯åˆ¤ç‡ä¼šä¸Šå‡ã€‚

æ‰€ä»¥éœ€è¦æå‰è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„æ•°å€¼é¿å…è¶…å‡ºå¯¼è‡´è¯¯åˆ¤ç‡å‡é«˜ã€‚å¦‚æœä¸ä½¿ç”¨ bf.reserveï¼Œé»˜è®¤çš„error_rateæ˜¯ 0.01ï¼Œé»˜è®¤çš„initial_sizeæ˜¯ 100ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ bf.reserve æ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„è„šæœ¬ï¼š

```python
# coding: utf-8

import redis
import random

client = redis.StrictRedis()

CHARS = ''.join([chr(ord('a') + i) for i in range(26)])

def random_string(n):
    chars = []
    for i in range(n):
        idx = random.randint(0, len(CHARS) - 1)
        chars.append(CHARS[idx])
    return ''.join(chars)


users = list(set([random_string(64) for i in range(100000)]))
print 'total users', len(users)
users_train = users[:len(users)/2]
users_test = users[len(users)/2:]


falses = 0
client.delete("codehole")
# å¢åŠ äº†ä¸‹é¢è¿™ä¸€å¥
client.execute_command("bf.reserve", "codehole", 0.001, 50000)
for user in users_train:
    client.execute_command("bf.add", "codehole", user)
print 'all trained'
for user in users_test:
    ret = client.execute_command("bf.exists", "codehole", user)
    if ret == 1:
        falses += 1

print falses, len(users_test)
```

Java ç‰ˆæœ¬ï¼š

```java
public class BloomTest {

  private String chars;
  {
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i < 26; i++) {
      builder.append((char) ('a' + i));
    }
    chars = builder.toString();
  }

  private String randomString(int n) {
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i < n; i++) {
      int idx = ThreadLocalRandom.current().nextInt(chars.length());
      builder.append(chars.charAt(idx));
    }
    return builder.toString();
  }

  private List<String> randomUsers(int n) {
    List<String> users = new ArrayList<>();
    for (int i = 0; i < 100000; i++) {
      users.add(randomString(64));
    }
    return users;
  }

  public static void main(String[] args) {
    BloomTest bloomer = new BloomTest();
    List<String> users = bloomer.randomUsers(100000);
    List<String> usersTrain = users.subList(0, users.size() / 2);
    List<String> usersTest = users.subList(users.size() / 2, users.size());

    Client client = new Client();
    client.delete("codehole");
    // å¯¹åº” bf.reserve æŒ‡ä»¤
    client.createFilter("codehole", 50000, 0.001);
    for (String user : usersTrain) {
      client.add("codehole", user);
    }
    int falses = 0;
    for (String user : usersTest) {
      boolean ret = client.exists("codehole", user);
      if (ret) {
        falses++;
      }
    }
    System.out.printf("%d %d\n", falses, usersTest.size());
    client.close();
  }

}
```

æˆ‘ä»¬çœ‹åˆ°äº†è¯¯åˆ¤ç‡å¤§çº¦ 0.012%ï¼Œæ¯”é¢„è®¡çš„ 0.1% ä½å¾ˆå¤šï¼Œä¸è¿‡å¸ƒéš†çš„æ¦‚ç‡æ˜¯æœ‰è¯¯å·®çš„ï¼Œåªè¦ä¸æ¯”é¢„è®¡è¯¯åˆ¤ç‡é«˜å¤ªå¤šï¼Œéƒ½æ˜¯æ­£å¸¸ç°è±¡ã€‚

## æ³¨æ„äº‹é¡¹

å¸ƒéš†è¿‡æ»¤å™¨çš„initial_sizeä¼°è®¡çš„è¿‡å¤§ï¼Œä¼šæµªè´¹å­˜å‚¨ç©ºé—´ï¼Œä¼°è®¡çš„è¿‡å°ï¼Œå°±ä¼šå½±å“å‡†ç¡®ç‡ï¼Œç”¨æˆ·åœ¨ä½¿ç”¨ä¹‹å‰ä¸€å®šè¦å°½å¯èƒ½åœ°ç²¾ç¡®ä¼°è®¡å¥½å…ƒç´ æ•°é‡ï¼Œè¿˜éœ€è¦åŠ ä¸Šä¸€å®šçš„å†—ä½™ç©ºé—´ä»¥é¿å…å®é™…å…ƒç´ å¯èƒ½ä¼šæ„å¤–é«˜å‡ºä¼°è®¡å€¼å¾ˆå¤šã€‚

å¸ƒéš†è¿‡æ»¤å™¨çš„error_rateè¶Šå°ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´å°±è¶Šå¤§ï¼Œå¯¹äºä¸éœ€è¦è¿‡äºç²¾ç¡®çš„åœºåˆï¼Œerror_rateè®¾ç½®ç¨å¤§ä¸€ç‚¹ä¹Ÿæ— ä¼¤å¤§é›…ã€‚æ¯”å¦‚åœ¨æ–°é—»å»é‡ä¸Šè€Œè¨€ï¼Œè¯¯åˆ¤ç‡é«˜ä¸€ç‚¹åªä¼šè®©å°éƒ¨åˆ†æ–‡ç« ä¸èƒ½è®©åˆé€‚çš„äººçœ‹åˆ°ï¼Œæ–‡ç« çš„æ•´ä½“é˜…è¯»é‡ä¸ä¼šå› ä¸ºè¿™ç‚¹è¯¯åˆ¤ç‡å°±å¸¦æ¥å·¨å¤§çš„æ”¹å˜ã€‚

## å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†

å­¦ä¼šäº†å¸ƒéš†è¿‡æ»¤å™¨çš„ä½¿ç”¨ï¼Œä¸‹é¢æœ‰å¿…è¦æŠŠåŸç†è§£é‡Šä¸€ä¸‹ï¼Œä¸ç„¶è¯»è€…è¿˜ä¼šç»§ç»­è’™åœ¨é¼“é‡Œ

![](A2C5D804-54E4-4E9A-9842-3940D492B9D5.png)

æ¯ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å¯¹åº”åˆ° Redis çš„æ•°æ®ç»“æ„é‡Œé¢å°±æ˜¯ä¸€ä¸ªå¤§å‹çš„ä½æ•°ç»„å’Œå‡ ä¸ªä¸ä¸€æ ·çš„æ— å hash å‡½æ•°ã€‚æ‰€è°“æ— åå°±æ˜¯èƒ½å¤ŸæŠŠå…ƒç´ çš„ hash å€¼ç®—å¾—æ¯”è¾ƒå‡åŒ€ã€‚

å‘å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ·»åŠ  key æ—¶ï¼Œä¼šä½¿ç”¨å¤šä¸ª hash å‡½æ•°å¯¹ key è¿›è¡Œ hash ç®—å¾—ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼ç„¶åå¯¹ä½æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—å¾—åˆ°ä¸€ä¸ªä½ç½®ï¼Œæ¯ä¸ª hash å‡½æ•°éƒ½ä¼šç®—å¾—ä¸€ä¸ªä¸åŒçš„ä½ç½®ã€‚å†æŠŠä½æ•°ç»„çš„è¿™å‡ ä¸ªä½ç½®éƒ½ç½®ä¸º 1 å°±å®Œæˆäº† add æ“ä½œã€‚

å‘å¸ƒéš†è¿‡æ»¤å™¨è¯¢é—® key æ˜¯å¦å­˜åœ¨æ—¶ï¼Œè·Ÿ add ä¸€æ ·ï¼Œä¹Ÿä¼šæŠŠ hash çš„å‡ ä¸ªä½ç½®éƒ½ç®—å‡ºæ¥ï¼Œçœ‹çœ‹ä½æ•°ç»„ä¸­è¿™å‡ ä¸ªä½ç½®æ˜¯å¦éƒ½ä½ 1ï¼Œåªè¦æœ‰ä¸€ä¸ªä½ä¸º 0ï¼Œé‚£ä¹ˆè¯´æ˜å¸ƒéš†è¿‡æ»¤å™¨ä¸­è¿™ä¸ª key ä¸å­˜åœ¨ã€‚å¦‚æœéƒ½æ˜¯ 1ï¼Œè¿™å¹¶ä¸èƒ½è¯´æ˜è¿™ä¸ª key å°±ä¸€å®šå­˜åœ¨ï¼Œåªæ˜¯ææœ‰å¯èƒ½å­˜åœ¨ï¼Œå› ä¸ºè¿™äº›ä½è¢«ç½®ä¸º 1 å¯èƒ½æ˜¯å› ä¸ºå…¶å®ƒçš„ key å­˜åœ¨æ‰€è‡´ã€‚å¦‚æœè¿™ä¸ªä½æ•°ç»„æ¯”è¾ƒç¨€ç–ï¼Œåˆ¤æ–­æ­£ç¡®çš„æ¦‚ç‡å°±ä¼šå¾ˆå¤§ï¼Œå¦‚æœè¿™ä¸ªä½æ•°ç»„æ¯”è¾ƒæ‹¥æŒ¤ï¼Œåˆ¤æ–­æ­£ç¡®çš„æ¦‚ç‡å°±ä¼šé™ä½ã€‚å…·ä½“çš„æ¦‚ç‡è®¡ç®—å…¬å¼æ¯”è¾ƒå¤æ‚ï¼Œæ„Ÿå…´è¶£å¯ä»¥é˜…è¯»æ‰©å±•é˜…è¯»ï¼Œéå¸¸çƒ§è„‘ï¼Œä¸å»ºè®®è¯»è€…ç»†çœ‹ã€‚

ä½¿ç”¨æ—¶ä¸è¦è®©å®é™…å…ƒç´ è¿œå¤§äºåˆå§‹åŒ–å¤§å°ï¼Œå½“å®é™…å…ƒç´ å¼€å§‹è¶…å‡ºåˆå§‹åŒ–å¤§å°æ—¶ï¼Œåº”è¯¥å¯¹å¸ƒéš†è¿‡æ»¤å™¨è¿›è¡Œé‡å»ºï¼Œé‡æ–°åˆ†é…ä¸€ä¸ª size æ›´å¤§çš„è¿‡æ»¤å™¨ï¼Œå†å°†æ‰€æœ‰çš„å†å²å…ƒç´ æ‰¹é‡ add è¿›å» (è¿™å°±è¦æ±‚æˆ‘ä»¬åœ¨å…¶å®ƒçš„å­˜å‚¨å™¨ä¸­è®°å½•æ‰€æœ‰çš„å†å²å…ƒç´ )ã€‚å› ä¸º error_rate ä¸ä¼šå› ä¸ºæ•°é‡è¶…å‡ºå°±æ€¥å‰§å¢åŠ ï¼Œè¿™å°±ç»™æˆ‘ä»¬é‡å»ºè¿‡æ»¤å™¨æä¾›äº†è¾ƒä¸ºå®½æ¾çš„æ—¶é—´ã€‚

## ç©ºé—´å ç”¨ä¼°è®¡

å¸ƒéš†è¿‡æ»¤å™¨çš„ç©ºé—´å ç”¨æœ‰ä¸€ä¸ªç®€å•çš„è®¡ç®—å…¬å¼ï¼Œä½†æ˜¯æ¨å¯¼æ¯”è¾ƒç¹çï¼Œè¿™é‡Œå°±çœå»æ¨å¯¼è¿‡ç¨‹äº†ï¼Œç›´æ¥å¼•å‡ºè®¡ç®—å…¬å¼ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥ç‚¹å‡»ã€Œæ‰©å±•é˜…è¯»ã€æ·±å…¥ç†è§£å…¬å¼çš„æ¨å¯¼è¿‡ç¨‹ã€‚

å¸ƒéš†è¿‡æ»¤å™¨æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯é¢„è®¡å…ƒç´ çš„æ•°é‡ nï¼Œç¬¬äºŒä¸ªæ˜¯é”™è¯¯ç‡ fã€‚å…¬å¼æ ¹æ®è¿™ä¸¤ä¸ªè¾“å…¥å¾—åˆ°ä¸¤ä¸ªè¾“å‡ºï¼Œç¬¬ä¸€ä¸ªè¾“å‡ºæ˜¯ä½æ•°ç»„çš„é•¿åº¦ lï¼Œä¹Ÿå°±æ˜¯éœ€è¦çš„å­˜å‚¨ç©ºé—´å¤§å° (bit)ï¼Œç¬¬äºŒä¸ªè¾“å‡ºæ˜¯ hash å‡½æ•°çš„æœ€ä½³æ•°é‡ kã€‚hash å‡½æ•°çš„æ•°é‡ä¹Ÿä¼šç›´æ¥å½±å“åˆ°é”™è¯¯ç‡ï¼Œæœ€ä½³çš„æ•°é‡ä¼šæœ‰æœ€ä½çš„é”™è¯¯ç‡ã€‚

```assembly
k=0.7*(l/n)  # çº¦ç­‰äº
f=0.6185^(l/n)  # ^ è¡¨ç¤ºæ¬¡æ–¹è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯ math.pow
```

ä»å…¬å¼ä¸­å¯ä»¥çœ‹å‡º

1. ä½æ•°ç»„ç›¸å¯¹è¶Šé•¿ (l/n)ï¼Œé”™è¯¯ç‡ f è¶Šä½ï¼Œè¿™ä¸ªå’Œç›´è§‚ä¸Šç†è§£æ˜¯ä¸€è‡´çš„
2. ä½æ•°ç»„ç›¸å¯¹è¶Šé•¿ (l/n)ï¼Œhash å‡½æ•°éœ€è¦çš„æœ€ä½³æ•°é‡ä¹Ÿè¶Šå¤šï¼Œå½±å“è®¡ç®—æ•ˆç‡
3. å½“ä¸€ä¸ªå…ƒç´ å¹³å‡éœ€è¦ 1 ä¸ªå­—èŠ‚ (8bit) çš„æŒ‡çº¹ç©ºé—´æ—¶ (l/n=8)ï¼Œé”™è¯¯ç‡å¤§çº¦ä¸º 2%
4. é”™è¯¯ç‡ä¸º 10%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 4.792 ä¸ª bitï¼Œå¤§çº¦ä¸º 5bit
5. é”™è¯¯ç‡ä¸º 1%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 9.585 ä¸ª bitï¼Œå¤§çº¦ä¸º 10bit
6. é”™è¯¯ç‡ä¸º 0.1%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 14.377 ä¸ª bitï¼Œå¤§çº¦ä¸º 15bit

ä½ ä¹Ÿè®¸ä¼šæƒ³ï¼Œå¦‚æœä¸€ä¸ªå…ƒç´ éœ€è¦å æ® 15 ä¸ª bitï¼Œé‚£ç›¸å¯¹ set é›†åˆçš„ç©ºé—´ä¼˜åŠ¿æ˜¯ä¸æ˜¯å°±æ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾äº†ï¼Ÿè¿™é‡Œéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œset ä¸­ä¼šå­˜å‚¨æ¯ä¸ªå…ƒç´ çš„å†…å®¹ï¼Œè€Œå¸ƒéš†è¿‡æ»¤å™¨ä»…ä»…å­˜å‚¨å…ƒç´ çš„æŒ‡çº¹ã€‚å…ƒç´ çš„å†…å®¹å¤§å°å°±æ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå®ƒä¸€èˆ¬ä¼šæœ‰å¤šä¸ªå­—èŠ‚ï¼Œç”šè‡³æ˜¯å‡ åä¸ªä¸Šç™¾ä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªå…ƒç´ æœ¬èº«è¿˜éœ€è¦ä¸€ä¸ªæŒ‡é’ˆè¢« set é›†åˆæ¥å¼•ç”¨ï¼Œè¿™ä¸ªæŒ‡é’ˆåˆä¼šå å» 4 ä¸ªå­—èŠ‚æˆ– 8 ä¸ªå­—èŠ‚ï¼Œå–å†³äºç³»ç»Ÿæ˜¯ 32bit è¿˜æ˜¯ 64bitã€‚è€ŒæŒ‡çº¹ç©ºé—´åªæœ‰æ¥è¿‘ 2 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¸ƒéš†è¿‡æ»¤å™¨çš„ç©ºé—´ä¼˜åŠ¿è¿˜æ˜¯éå¸¸æ˜æ˜¾çš„ã€‚

å¦‚æœè¯»è€…è§‰å¾—å…¬å¼è®¡ç®—èµ·æ¥å¤ªéº»çƒ¦ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæœ‰å¾ˆå¤šç°æˆçš„ç½‘ç«™å·²ç»æ”¯æŒè®¡ç®—ç©ºé—´å ç”¨çš„åŠŸèƒ½äº†ï¼Œæˆ‘ä»¬åªè¦æŠŠå‚æ•°è¾“è¿›å»ï¼Œå°±å¯ä»¥ç›´æ¥çœ‹åˆ°ç»“æœï¼Œæ¯”å¦‚ å¸ƒéš†è®¡ç®—å™¨

![](5316CBCA-E376-4594-8662-B075711C3A07.png)

## å®é™…å…ƒç´ è¶…å‡ºæ—¶ï¼Œè¯¯åˆ¤ç‡ä¼šæ€æ ·å˜åŒ–

å½“å®é™…å…ƒç´ è¶…å‡ºé¢„è®¡å…ƒç´ æ—¶ï¼Œé”™è¯¯ç‡ä¼šæœ‰å¤šå¤§å˜åŒ–ï¼Œå®ƒä¼šæ€¥å‰§ä¸Šå‡ä¹ˆï¼Œè¿˜æ˜¯å¹³ç¼“åœ°ä¸Šå‡ï¼Œè¿™å°±éœ€è¦å¦å¤–ä¸€ä¸ªå…¬å¼ï¼Œå¼•å…¥å‚æ•° t è¡¨ç¤ºå®é™…å…ƒç´ å’Œé¢„è®¡å…ƒç´ çš„å€æ•° t

```assembly
f=(1-0.5^t)^k  # æé™è¿‘ä¼¼ï¼Œk æ˜¯ hash å‡½æ•°çš„æœ€ä½³æ•°é‡
```

å½“ t å¢å¤§æ—¶ï¼Œé”™è¯¯ç‡ï¼Œf ä¹Ÿä¼šè·Ÿç€å¢å¤§ï¼Œåˆ†åˆ«é€‰æ‹©é”™è¯¯ç‡ä¸º 10%,1%,0.1% çš„ k å€¼ï¼Œç”»å‡ºå®ƒçš„æ›²çº¿è¿›è¡Œç›´è§‚è§‚å¯Ÿ

![](74E56753-D7AC-45F1-A596-022F8B26FFBD.png)

ä»è¿™ä¸ªå›¾ä¸­å¯ä»¥çœ‹å‡ºæ›²çº¿è¿˜æ˜¯æ¯”è¾ƒé™¡å³­çš„

1. é”™è¯¯ç‡ä¸º 10% æ—¶ï¼Œå€æ•°æ¯”ä¸º 2 æ—¶ï¼Œé”™è¯¯ç‡å°±ä¼šå‡è‡³æ¥è¿‘ 40%ï¼Œè¿™ä¸ªå°±æ¯”è¾ƒå±é™©äº†
2. é”™è¯¯ç‡ä¸º 1% æ—¶ï¼Œå€æ•°æ¯”ä¸º 2 æ—¶ï¼Œé”™è¯¯ç‡å‡è‡³ 15%ï¼Œä¹ŸæŒºå¯æ€•çš„
3. é”™è¯¯ç‡ä¸º 0.1%ï¼Œå€æ•°æ¯”ä¸º 2 æ—¶ï¼Œé”™è¯¯ç‡å‡è‡³ 5%ï¼Œä¹Ÿæ¯”è¾ƒæ‚¬äº†

## ç”¨ä¸ä¸Š Redis4.0 æ€ä¹ˆåŠï¼Ÿ

Redis 4.0 ä¹‹å‰ä¹Ÿæœ‰ç¬¬ä¸‰æ–¹çš„å¸ƒéš†è¿‡æ»¤å™¨ lib ä½¿ç”¨ï¼Œåªä¸è¿‡åœ¨å®ç°ä¸Šä½¿ç”¨ redis çš„ä½å›¾æ¥å®ç°çš„ï¼Œæ€§èƒ½ä¸Šä¹Ÿè¦å·®ä¸å°‘ã€‚æ¯”å¦‚ä¸€æ¬¡ exists æŸ¥è¯¢ä¼šæ¶‰åŠåˆ°å¤šæ¬¡ getbit æ“ä½œï¼Œç½‘ç»œå¼€é”€ç›¸æ¯”è€Œè¨€ä¼šé«˜å‡ºä¸å°‘ã€‚å¦å¤–åœ¨å®ç°ä¸Šè¿™äº›ç¬¬ä¸‰æ–¹ lib ä¹Ÿä¸å°½å®Œç¾ï¼Œæ¯”å¦‚ pyrebloom åº“å°±ä¸æ”¯æŒé‡è¿å’Œé‡è¯•ï¼Œåœ¨ä½¿ç”¨æ—¶éœ€è¦å¯¹å®ƒåšä¸€å±‚å°è£…åæ‰èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

1. [Python Redis Bloom Filter](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Frobinhoodmarkets%2FpyreBloom)
2. [Java Redis Bloom Filter](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FBaqend%2FOrestes-Bloomfilter)

## å¸ƒéš†è¿‡æ»¤å™¨çš„å…¶å®ƒåº”ç”¨

åœ¨çˆ¬è™«ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ URL è¿›è¡Œå»é‡ï¼Œå·²ç»çˆ¬è¿‡çš„ç½‘é¡µå°±å¯ä»¥ä¸ç”¨çˆ¬äº†ã€‚ä½†æ˜¯ URL å¤ªå¤šäº†ï¼Œå‡ åƒä¸‡å‡ ä¸ªäº¿ï¼Œå¦‚æœç”¨ä¸€ä¸ªé›†åˆè£…ä¸‹è¿™äº› URL åœ°å€é‚£æ˜¯éå¸¸æµªè´¹ç©ºé—´çš„ã€‚è¿™æ—¶å€™å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ã€‚å®ƒå¯ä»¥å¤§å¹…é™ä½å»é‡å­˜å‚¨æ¶ˆè€—ï¼Œåªä¸è¿‡ä¹Ÿä¼šä½¿å¾—çˆ¬è™«ç³»ç»Ÿé”™è¿‡å°‘é‡çš„é¡µé¢ã€‚

å¸ƒéš†è¿‡æ»¤å™¨åœ¨ NoSQL æ•°æ®åº“é¢†åŸŸä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œæˆ‘ä»¬å¹³æ—¶ç”¨åˆ°çš„ HBaseã€Cassandra è¿˜æœ‰ LevelDBã€RocksDB å†…éƒ¨éƒ½æœ‰å¸ƒéš†è¿‡æ»¤å™¨ç»“æ„ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥æ˜¾è‘—é™ä½æ•°æ®åº“çš„ IO è¯·æ±‚æ•°é‡ã€‚å½“ç”¨æˆ·æ¥æŸ¥è¯¢æŸä¸ª row æ—¶ï¼Œå¯ä»¥å…ˆé€šè¿‡å†…å­˜ä¸­çš„å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤æ‰å¤§é‡ä¸å­˜åœ¨çš„ row è¯·æ±‚ï¼Œç„¶åå†å»ç£ç›˜è¿›è¡ŒæŸ¥è¯¢ã€‚

é‚®ç®±ç³»ç»Ÿçš„åƒåœ¾é‚®ä»¶è¿‡æ»¤åŠŸèƒ½ä¹Ÿæ™®éç”¨åˆ°äº†å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå› ä¸ºç”¨äº†è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œæ‰€ä»¥å¹³æ—¶ä¹Ÿä¼šé‡åˆ°æŸäº›æ­£å¸¸çš„é‚®ä»¶è¢«æ”¾è¿›äº†åƒåœ¾é‚®ä»¶ç›®å½•ä¸­ï¼Œè¿™ä¸ªå°±æ˜¯è¯¯åˆ¤æ‰€è‡´ï¼Œæ¦‚ç‡å¾ˆä½ã€‚